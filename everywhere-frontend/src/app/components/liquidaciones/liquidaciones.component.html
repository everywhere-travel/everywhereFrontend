<div class="container">
  <div class="page-header">
    <h1>Gestión de Liquidaciones</h1>
    <p>Procesa liquidaciones y facturación de paquetes turísticos</p>
  </div>

   Search Section 
  <div class="search-section">
    <form [formGroup]="searchForm" class="search-container">
      <select formControlName="searchType" class="form-input search-select">
        <option value="numero">Por Número</option>
        <option value="viajero">Por Viajero</option>
        <option value="cotizacion">Por Cotización</option>
      </select>
      <input
        type="text"
        formControlName="searchValue"
        (keyup.enter)="searchLiquidaciones()"
        placeholder="Buscar liquidación..."
        class="form-input search-input"
      />
      <button type="button" (click)="searchLiquidaciones()" class="btn btn-primary">
        Buscar
      </button>
      <button type="button" (click)="toggleForm()" class="btn btn-secondary">
        {{ showForm ? 'Cancelar' : 'Nueva Liquidación' }}
      </button>
    </form>
  </div>

   Form Section 
  <div *ngIf="showForm" class="form-section">
    <div class="card">
      <h3>{{ editingId ? 'Editar' : 'Nueva' }} Liquidación</h3>
      
      <form [formGroup]="liquidacionForm" (ngSubmit)="onSubmit()">
         Basic Information 
        <div class="form-section-title">Información Básica</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Número de Liquidación *</label>
            <input type="text" formControlName="numero" class="form-input" readonly />
          </div>
          <div class="form-group">
            <label class="form-label">Fecha de Liquidación *</label>
            <input type="date" formControlName="fechaLiquidacion" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Cotización Base *</label>
            <select formControlName="cotizacionId" (change)="onCotizacionChange()" class="form-input">
              <option value="">Seleccionar cotización...</option>
              <option *ngFor="let cotizacion of cotizaciones" [value]="cotizacion.id">
                {{ cotizacion.numero }} - {{ cotizacion.total | currency:'PEN':'symbol':'1.2-2' }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Estado *</label>
            <select formControlName="estado" class="form-input">
              <option *ngFor="let estado of estados" [value]="estado.value">
                {{ estado.label }}
              </option>
            </select>
          </div>
        </div>

         Quotation Summary 
        <div *ngIf="selectedCotizacion" class="quotation-summary">
          <h4>Resumen de Cotización</h4>
          <div class="summary-grid">
            <div class="summary-item">
              <span class="label">Número:</span>
              <span class="value">{{ selectedCotizacion.numero }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Fecha Viaje:</span>
              <span class="value">{{ selectedCotizacion.fechaViaje | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Pasajeros:</span>
              <span class="value">{{ selectedCotizacion.numeroAdultos + selectedCotizacion.numeroNinos }} pax</span>
            </div>
            <div class="summary-item">
              <span class="label">Total:</span>
              <span class="value">{{ selectedCotizacion.total | currency:'PEN':'symbol':'1.2-2' }}</span>
            </div>
          </div>
        </div>

         Traveler and Service Information 
        <div class="form-section-title">Información del Viajero y Servicios</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Viajero Principal *</label>
            <select formControlName="viajeroId" class="form-input">
              <option value="">Seleccionar viajero...</option>
              <option *ngFor="let viajero of viajeros" [value]="viajero.id">
                {{ viajero.nombre }} {{ viajero.apellido }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Número de Ticket</label>
            <input type="text" formControlName="numeroTicket" class="form-input" placeholder="TKT001" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Operador</label>
            <select formControlName="operadorId" class="form-input">
              <option value="">Seleccionar operador...</option>
              <option *ngFor="let operador of operadores" [value]="operador.id">
                {{ operador.nombre }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Proveedor</label>
            <select formControlName="proveedorId" class="form-input">
              <option value="">Seleccionar proveedor...</option>
              <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                {{ proveedor.nombre }}
              </option>
            </select>
          </div>
        </div>

         Financial Information 
        <div class="form-section-title">Información Financiera</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Costo del Servicio *</label>
            <input type="number" formControlName="costoServicio" step="0.01" min="0" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">Cargo del Servicio</label>
            <input type="number" formControlName="cargoServicio" step="0.01" min="0" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Valor de Venta *</label>
            <input type="number" formControlName="valorVenta" step="0.01" min="0" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">Cargo Adicional</label>
            <input type="number" formControlName="cargoAdicional" step="0.01" min="0" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Descuento</label>
            <input type="number" formControlName="descuento" step="0.01" min="0" class="form-input" />
          </div>
        </div>

         Invoice Information 
        <div class="form-section-title">Información de Facturación</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Número de Factura</label>
            <input type="text" formControlName="numeroFactura" class="form-input" placeholder="F001-00001" />
          </div>
          <div class="form-group">
            <label class="form-label">Número de Recibo</label>
            <input type="text" formControlName="numeroRecibo" class="form-input" placeholder="R001-00001" />
          </div>
        </div>

         Payment Information 
        <div class="form-section-title">Información de Pagos</div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Pago en Soles (PEN)</label>
            <input type="number" formControlName="pagoSoles" step="0.01" min="0" class="form-input" />
          </div>
          <div class="form-group">
            <label class="form-label">Pago en Dólares (USD)</label>
            <input type="number" formControlName="pagoDolares" step="0.01" min="0" class="form-input" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Pago en Euros (EUR)</label>
            <input type="number" formControlName="pagoEuros" step="0.01" min="0" class="form-input" />
          </div>
        </div>

         Payment Summary 
        <div class="payment-summary">
          <div class="summary-card">
            <h4>Resumen de Pagos</h4>
            <div class="summary-row">
              <span>Total a Pagar:</span>
              <span class="amount">{{ calculateTotal() | currency:'PEN':'symbol':'1.2-2' }}</span>
            </div>
            <div class="summary-row">
              <span>Total Pagado:</span>
              <span class="amount">{{ calculateTotalPayments() | currency:'PEN':'symbol':'1.2-2' }}</span>
            </div>
            <div class="summary-row balance-row">
              <span>Saldo:</span>
              <span [class]="'amount ' + (getPaymentBalance() > 0 ? 'pending' : 'paid')">
                {{ getPaymentBalance() | currency:'PEN':'symbol':'1.2-2' }}
              </span>
            </div>
          </div>
        </div>

         Service Details 
        <div class="details-section">
          <h4>Detalles de Servicios</h4>
          
          <div *ngIf="detallesLiquidacion.length === 0" class="empty-message">
            No hay detalles de servicios
          </div>

          <table *ngIf="detallesLiquidacion.length > 0" class="table details-table">
            <thead>
              <tr>
                <th>Descripción</th>
                <th>Cantidad</th>
                <th>Precio Unit.</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detalle of detallesLiquidacion; let i = index">
                <td>
                  <input
                    type="text"
                    [(ngModel)]="detalle.descripcion"
                    [ngModelOptions]="{standalone: true}"
                    class="form-input"
                    placeholder="Descripción del servicio"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    [(ngModel)]="detalle.cantidad"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="updateDetailSubtotal(i)"
                    min="1"
                    class="form-input quantity-input"
                  />
                </td>
                <td>
                  <input
                    type="number"
                    [(ngModel)]="detalle.precioUnitario"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="updateDetailSubtotal(i)"
                    step="0.01"
                    min="0"
                    class="form-input price-input"
                  />
                </td>
                <td class="subtotal-cell">
                  {{ detalle.subtotal | currency:'PEN':'symbol':'1.2-2' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

         Observations 
        <div class="form-group">
          <label class="form-label">Observaciones</label>
          <textarea formControlName="observaciones" class="form-input" rows="4" placeholder="Observaciones adicionales sobre la liquidación..."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" [disabled]="!liquidacionForm.valid" class="btn btn-primary">
            {{ editingId ? 'Actualizar' : 'Guardar' }} Liquidación
          </button>
          <button type="button" (click)="toggleForm()" class="btn btn-outline">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

   Liquidations List 
  <div class="table-section">
    <div class="card">
      <h3>Lista de Liquidaciones</h3>

      <div *ngIf="loading" class="loading-message">
        Cargando liquidaciones...
      </div>

      <div *ngIf="!loading && liquidaciones.length === 0" class="empty-message">
        No hay liquidaciones para mostrar
      </div>

      <table *ngIf="!loading && liquidaciones.length > 0" class="table">
        <thead>
          <tr>
            <th>Número</th>
            <th>Cotización</th>
            <th>Viajero</th>
            <th>Fecha</th>
            <th>Total</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let liquidacion of liquidaciones">
            <td>{{ liquidacion.numero }}</td>
            <td>{{ getCotizacionNumber(liquidacion.cotizacionId) }}</td>
            <td>{{ getViajeroName(liquidacion.viajeroId) }}</td>
            <td>{{ liquidacion.fechaLiquidacion | date:'dd/MM/yyyy' }}</td>
            <td>{{ liquidacion.total | currency:'PEN':'symbol':'1.2-2' }}</td>
            <td>
              <span [class]="'badge ' + getEstadoBadgeClass(liquidacion.estado)">
                {{ liquidacion.estado | titlecase }}
              </span>
            </td>
            <td>
              <button (click)="editLiquidacion(liquidacion)" class="btn btn-sm btn-outline">
                Editar
              </button>
              <button (click)="deleteLiquidacion(liquidacion.id!)" class="btn btn-sm btn-error">
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
