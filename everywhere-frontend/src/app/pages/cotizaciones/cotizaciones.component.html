<div class="min-h-screen bg-gradient-to-br from-gray-50 to-slate-100">
  <!-- Sidebar Component -->
  <app-sidebar [isCollapsed]="sidebarCollapsed" [menuItems]="sidebarMenuItems" (itemClick)="onSidebarItemClick($event)"
    (toggleSidebar)="onToggleSidebar()">
  </app-sidebar>

  <!-- Main Content Area -->
  <div class="transition-all duration-300" [class.ml-72]="!sidebarCollapsed" [class.ml-20]="sidebarCollapsed">
    <!-- Messages Section -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
      <!-- Success Message -->
      <div *ngIf="showSuccessMessage"
        class="bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in">
        <i class="fas fa-check-circle text-xl"></i>
        <span>{{ successMessage }}</span>
        <button (click)="hideMessages()" class="ml-4 hover:text-green-200">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Error Message -->
      <div *ngIf="showErrorMessage"
        class="bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in">
        <i class="fas fa-exclamation-triangle text-xl"></i>
        <span>{{ errorMessage }}</span>
        <button (click)="hideMessages()" class="ml-4 hover:text-red-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Header Section -->
    <header
      class="bg-gradient-to-r from-everywhere-primary to-everywhere-secondary text-white relative overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-white/20 transform skew-x-12">
      </div>

      <div class="max-w-full mx-auto px-6 py-6 relative z-10">
        <!-- Mobile Menu Button -->
        <button (click)="onToggleSidebar()"
          class="lg:hidden fixed top-4 left-4 z-50 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center border border-white/30 hover:bg-white/30 transition-all">
          <i class="fas fa-bars text-xl"></i>
        </button>

        <div class="flex flex-col lg:flex-row justify-between items-start gap-8">
          <!-- Header Info -->
          <div class="flex-1">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                <i class="fas fa-file-invoice-dollar text-2xl"></i>
              </div>
              <div>
                <h1 class="text-4xl font-bold">Gestión de Cotizaciones</h1>
                <p class="text-xl opacity-90 mt-2">
                  Administra y organiza todas tus cotizaciones de manera eficiente
                </p>
              </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8" *ngIf="!isLoading">
              <div
                class="bg-white/15 backdrop-blur-sm border border-white/20 rounded-2xl p-4 flex items-center gap-4 hover:bg-white/20 transition-all duration-300 hover:-translate-y-1">
                <div class="w-14 h-14 bg-everywhere-blue rounded-xl flex items-center justify-center">
                  <i class="fas fa-file-invoice text-white text-xl"></i>
                </div>
                <div>
                  <div class="text-2xl font-bold">{{ getTotalCotizaciones() }}</div>
                  <div class="text-sm opacity-90 uppercase font-medium tracking-wide">
                    Cotización{{ getTotalCotizaciones() === 1 ? '' : 'es' }} Total{{
                    getTotalCotizaciones() === 1 ? '' : 'es'
                    }}
                  </div>
                </div>
              </div>

              <div
                class="bg-white/15 backdrop-blur-sm border border-white/20 rounded-2xl p-4 flex items-center gap-4 hover:bg-white/20 transition-all duration-300 hover:-translate-y-1">
                <div class="w-14 h-14 bg-green-500 rounded-xl flex items-center justify-center">
                  <i class="fas fa-check-circle text-white text-xl"></i>
                </div>
                <div>
                  <div class="text-2xl font-bold">{{ getCotizacionesAprobadas() }}</div>
                  <div class="text-sm opacity-90 uppercase font-medium tracking-wide">
                    Aprobada{{ getCotizacionesAprobadas() === 1 ? '' : 's' }}
                  </div>
                </div>
              </div>

              <div
                class="bg-white/15 backdrop-blur-sm border border-white/20 rounded-2xl p-4 flex items-center gap-4 hover:bg-white/20 transition-all duration-300 hover:-translate-y-1">
                <div class="w-14 h-14 bg-yellow-500 rounded-xl flex items-center justify-center">
                  <i class="fas fa-clock text-white text-xl"></i>
                </div>
                <div>
                  <div class="text-2xl font-bold">{{ getCotizacionesPorConfirmar() }}</div>
                  <div class="text-sm opacity-90 uppercase font-medium tracking-wide">
                    Por Confirmar
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Header Action -->
          <div class="z-10">
            <button (click)="mostrarFormularioCrear()" [disabled]="isLoading"
              class="bg-white text-red-600 hover:bg-gray-50 px-8 py-4 rounded-2xl font-bold flex items-center gap-3 shadow-xl hover:shadow-2xl transition-all duration-300 hover:-translate-y-1 min-w-48 justify-center relative overflow-hidden group">
              <div
                class="absolute inset-0 bg-gradient-to-r from-transparent via-red-50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700">
              </div>
              <i class="fas fa-plus text-lg"></i>
              <span>Nueva Cotización</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-full mx-auto px-6 py-6 space-y-6">
      <!-- Search & Filters Panel -->
      <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        <!-- Panel Header -->
        <div class="bg-gradient-to-r from-gray-50 to-white px-6 py-4 border-b border-gray-200">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-everywhere-primary rounded-xl flex items-center justify-center">
                <i class="fas fa-search text-white"></i>
              </div>
              <div>
                <h2 class="text-lg font-bold text-gray-900">Buscar y Filtrar</h2>
                <p class="text-sm text-gray-600">Encuentra cotizaciones específicas</p>
              </div>
            </div>

            <!-- View Controls -->
            <div class="flex items-center gap-2 bg-gray-100 rounded-xl p-1">
              <button class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200" [class]="
                  currentView === 'table'
                    ? 'bg-white text-everywhere-primary shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                " (click)="changeView('table')" title="Vista de Tabla">
                <i class="fas fa-table mr-2"></i>Tabla
              </button>
              <button class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200" [class]="
                  currentView === 'cards'
                    ? 'bg-white text-everywhere-primary shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                " (click)="changeView('cards')" title="Vista de Tarjetas">
                <i class="fas fa-th mr-2"></i>Tarjetas
              </button>
              <button class="px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200" [class]="
                  currentView === 'list'
                    ? 'bg-white text-everywhere-primary shadow-sm'
                    : 'text-gray-600 hover:text-gray-900'
                " (click)="changeView('list')" title="Vista de Lista">
                <i class="fas fa-list mr-2"></i>Lista
              </button>
            </div>
          </div>
        </div>

        <!-- Search Controls -->
        <div class="p-4 grid grid-cols-1 lg:grid-cols-3 gap-8" [formGroup]="searchForm">
          <!-- Search Input -->
          <div class="lg:col-span-2">
            <div class="relative">
              <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
              <input type="text" placeholder="Buscar por código, cliente o destino..." formControlName="searchTerm"
                class="w-full pl-12 pr-10 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-everywhere-primary focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white" />
              <button *ngIf="searchForm.get('searchTerm')?.value"
                class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 transition-colors"
                (click)="clearSearch()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
        <div class="flex flex-col items-center justify-center py-16 px-6">
          <div
            class="w-16 h-16 bg-gradient-to-r from-everywhere-primary to-everywhere-secondary rounded-2xl flex items-center justify-center mb-4">
            <i class="fas fa-spinner fa-spin text-white text-2xl"></i>
          </div>
          <h3 class="text-lg font-bold text-gray-900 mb-2">Cargando Cotizaciones</h3>
          <p class="text-gray-600">Por favor espera mientras obtenemos los datos...</p>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && filteredCotizaciones.length === 0"
        class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden p-12 text-center">
        <div class="w-24 h-24 mx-auto mb-6 bg-gray-100 rounded-full flex items-center justify-center">
          <i class="fas fa-file-invoice-dollar text-4xl text-gray-400"></i>
        </div>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">No hay cotizaciones</h3>
        <p class="text-gray-600 mb-6">
          No se encontraron cotizaciones con los criterios de búsqueda.
        </p>
        <button (click)="mostrarFormularioCrear()"
          class="inline-flex items-center px-6 py-3 bg-everywhere-primary text-white rounded-xl font-semibold hover:bg-everywhere-secondary transition-all duration-200">
          <i class="fas fa-plus mr-2"></i>
          Crear Primera Cotización
        </button>
      </div>

      <!-- Data Content -->
      <div *ngIf="!isLoading && filteredCotizaciones.length > 0" class="space-y-2">
        <!-- Data Header -->
        <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden">
          <div class="bg-gradient-to-r from-gray-50 to-white px-8 py-4">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
              <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-3">
                  <i class="fas fa-database text-red-600"></i>
                  <h2 class="text-xl font-bold text-gray-900">Lista de Cotizaciones</h2>
                </div>
              </div>

              <div class="flex gap-3">
                <button (click)="refreshData()"
                  class="bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 hover:border-gray-400 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-all duration-200 hover:-translate-y-0.5">
                  <i class="fas fa-sync-alt"></i>
                  <span>Actualizar</span>
                </button>
                <button (click)="mostrarFormularioCrear()"
                  class="bg-gradient-to-r from-[#D9043D] to-[#BF4968] text-white hover:from-[#D9043D]/90 hover:to-[#BF4968]/90 px-4 py-2 rounded-lg font-medium flex items-center gap-2 transition-all duration-200 hover:-translate-y-0.5 shadow-lg">
                  <i class="fas fa-plus"></i>
                  <span>Nueva Cotización</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div
          class="bg-blue-600 text-white px-8 py-4 flex justify-between items-center animate-in slide-in-from-top duration-300"
          *ngIf="selectedItems.length > 0">
          <div class="flex items-center gap-3 font-semibold">
            <i class="fas fa-check-circle"></i>
            <span>{{ selectedItems.length }} cotización{{
              selectedItems.length === 1 ? '' : 'es'
              }}
              seleccionada{{ selectedItems.length === 1 ? '' : 's' }}</span>
          </div>
          <div class="flex gap-3">
            <button (click)="editarSeleccionados()"
              class="bg-white/20 border border-white/30 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
              <i class="fas fa-edit"></i>
              Editar
            </button>
            <button (click)="eliminarSeleccionados()"
              class="bg-white/20 border border-white/30 hover:bg-red-600 hover:border-red-600 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
              <i class="fas fa-trash"></i>
              Eliminar seleccionados
            </button>
            <button (click)="clearSelection()"
              class="bg-white/20 border border-white/30 hover:bg-white/30 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-colors">
              <i class="fas fa-times"></i>
              Cancelar
            </button>
          </div>
        </div>

        <!-- Table View -->
        <div *ngIf="currentView === 'table'"
          class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <!-- Table Header -->
              <thead class="bg-gray-50">
                <tr>
                  <th class="w-12 p-5 text-center">
                    <label class="relative inline-block cursor-pointer">
                      <input type="checkbox" [checked]="allSelected" [indeterminate]="someSelected"
                        (change)="toggleAllSelection()" class="absolute opacity-0 w-0 h-0" />
                      <span
                        class="w-5 h-5 bg-white border-2 border-gray-300 rounded-md flex items-center justify-center transition-all duration-200 hover:border-red-500 hover:shadow-lg hover:shadow-red-100"
                        [class.bg-red-600]="allSelected || someSelected"
                        [class.border-red-600]="allSelected || someSelected">
                        <i class="fas fa-check text-white text-xs" [class.hidden]="!allSelected && !someSelected"></i>
                        <i class="fas fa-minus text-white text-xs" [class.hidden]="!someSelected || allSelected"></i>
                      </span>
                    </label>
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Código
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Cliente
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Destino
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Fechas
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Pax
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Estado
                  </th>
                  <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Moneda
                  </th>
                  <th class="px-6 py-4 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Acciones
                  </th>
                </tr>
              </thead>

              <!-- Table Body -->
              <tbody class="bg-white divide-y divide-gray-200">
                <tr *ngFor="let cotizacion of filteredCotizaciones; trackBy: trackByCotizacion"
                  class="hover:bg-gray-50 transition-colors duration-200">
                  <!-- Checkbox -->
                  <td class="p-5 text-center">
                    <label class="relative inline-block cursor-pointer">
                      <input type="checkbox" [checked]="isSelected(cotizacion.id)"
                        (change)="toggleSelection(cotizacion.id)" class="absolute opacity-0 w-0 h-0" />
                      <span
                        class="w-5 h-5 bg-white border-2 border-gray-300 rounded-md flex items-center justify-center transition-all duration-200 hover:border-red-500 hover:shadow-lg hover:shadow-red-100"
                        [class.bg-red-600]="isSelected(cotizacion.id)"
                        [class.border-red-600]="isSelected(cotizacion.id)">
                        <i class="fas fa-check text-white text-xs" [class.hidden]="!isSelected(cotizacion.id)"></i>
                      </span>
                    </label>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="w-10 h-10 bg-everywhere-primary/10 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-file-invoice text-everywhere-primary"></i>
                      </div>
                      <div>
                        <div class="text-sm font-medium text-gray-900">
                          {{ cotizacion.codigoCotizacion }}
                        </div>
                        <div class="text-sm text-gray-500">
                          {{ formatDate(cotizacion.fechaEmision) }}
                        </div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">
                      {{ getPersonaDisplayName(cotizacion.personas?.id || 0) }}
                    </div>
                    <div class="text-sm text-gray-500">
                      {{ getPersonaDocumento(cotizacion.personas?.id || 0) }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">
                      {{ cotizacion.origenDestino || 'No especificado' }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">
                      {{ formatDate(cotizacion.fechaSalida) }}
                    </div>
                    <div class="text-sm text-gray-500">
                      {{ formatDate(cotizacion.fechaRegreso) }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">
                      <span class="inline-flex items-center">
                        <i class="fas fa-user mr-1"></i>
                        {{ cotizacion.cantAdultos || 0 }}
                      </span>
                      <span *ngIf="cotizacion.cantNinos && cotizacion.cantNinos > 0"
                        class="ml-2 inline-flex items-center">
                        <i class="fas fa-child mr-1"></i>
                        {{ cotizacion.cantNinos }}
                      </span>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                      [ngClass]="getEstadoBadgeClass(cotizacion.estadoCotizacion)">
                      {{ cotizacion.estadoCotizacion?.descripcion || 'Sin estado' }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">
                      {{ cotizacion.moneda || 'USD' }}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <div class="flex justify-end space-x-2">
                      <button (click)="mostrarModalVerCotizacion(cotizacion)"
                        class="inline-flex items-center p-2 bg-green-50 text-green-700 hover:bg-green-100 hover:text-green-900 rounded-lg transition-all duration-200"
                        title="Ver detalles">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button (click)="mostrarFormularioEditar(cotizacion)"
                        class="inline-flex items-center p-2 bg-blue-50 text-blue-700 hover:bg-blue-100 hover:text-blue-900 rounded-lg transition-all duration-200"
                        title="Editar">
                        <i class="fas fa-edit"></i>
                      </button>
                      <!-- Botón de eliminar con presión mantenida -->
                      <button (mousedown)="iniciarEliminacion(cotizacion)" (mouseup)="cancelarEliminacion()"
                        (mouseleave)="cancelarEliminacion()" (touchstart)="iniciarEliminacion(cotizacion)"
                        (touchend)="cancelarEliminacion()" [class]="
                          'relative inline-flex items-center p-2 rounded-lg transition-all duration-200 ' +
                          (presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                            ? 'text-white bg-red-600'
                            : 'text-red-700 bg-red-50 hover:bg-red-100 hover:text-red-900')
                        " [title]="
                          presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                            ? 'Mantenga presionado 3 segundos para eliminar...'
                            : 'Mantener presionado 3 segundos para eliminar'
                        " type="button">
                        <!-- Icono de basura -->
                        <i class="fas fa-trash relative z-10"></i>

                        <!-- Barra de progreso -->
                        <div *ngIf="presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id"
                          class="absolute inset-0 bg-red-700 rounded-lg transition-all duration-100 ease-linear"
                          [style.width.%]="getPorcentajeProgreso()"></div>

                        <!-- Contador visual -->
                        <span *ngIf="presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id"
                          class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-red-600 text-white text-xs px-2 py-1 rounded shadow-lg z-20">
                          {{ 3 - getMath().floor(tiempoPresionado / 1000) }}s
                        </span>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cards View -->
        <div *ngIf="currentView === 'cards'"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
          <div *ngFor="let cotizacion of filteredCotizaciones; trackBy: trackByCotizacion"
            class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 group relative"
            [class.border-red-500]="isSelected(cotizacion.id)" [class.shadow-red-200]="isSelected(cotizacion.id)">
            <!-- Checkbox de selección -->
            <div class="absolute top-4 left-4 z-10">
              <label class="relative inline-block cursor-pointer">
                <input type="checkbox" [checked]="isSelected(cotizacion.id)" (change)="toggleSelection(cotizacion.id)"
                  class="absolute opacity-0 w-0 h-0" />
                <span
                  class="w-6 h-6 bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center transition-all duration-200 hover:border-red-500 shadow-sm"
                  [class.bg-red-600]="isSelected(cotizacion.id)" [class.border-red-600]="isSelected(cotizacion.id)">
                  <i class="fas fa-check text-white text-xs" [class.hidden]="!isSelected(cotizacion.id)"></i>
                </span>
              </label>
            </div>

            <!-- Badge de estado en la esquina superior derecha -->
            <div class="absolute top-4 right-4">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                [ngClass]="getEstadoBadgeClass(cotizacion.estadoCotizacion)">
                {{ cotizacion.estadoCotizacion?.descripcion || 'Sin estado' }}
              </span>
            </div>

            <div class="p-6 pt-16">
              <div class="mb-4">
                <!-- Código y fecha -->
                <div class="flex items-center gap-3 mb-2">
                  <div class="w-8 h-8 bg-everywhere-primary/10 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-invoice-dollar text-everywhere-primary text-sm"></i>
                  </div>
                  <div>
                    <h3 class="text-lg font-bold text-gray-900">
                      {{ cotizacion.codigoCotizacion }}
                    </h3>
                    <div class="text-sm text-gray-500">
                      {{ formatDate(cotizacion.fechaEmision) }}
                    </div>
                  </div>
                </div>

                <!-- Cliente -->
                <div class="text-sm text-gray-600 mb-2">
                  <i class="fas fa-user mr-2 text-blue-500"></i>
                  {{ getPersonaDisplayName(cotizacion.personas?.id || 0) }}
                </div>
              </div>

              <!-- Información del viaje -->
              <div class="space-y-3 mb-6">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-green-500"></i>
                    Destino:
                  </span>
                  <span class="text-sm text-gray-900 font-medium text-right">{{
                    cotizacion.origenDestino ||
                    'No especificado'
                    }}</span>
                </div>

                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-calendar-alt mr-2 text-purple-500"></i>
                    Fechas:
                  </span>
                  <div class="text-sm text-gray-900 font-medium text-right">
                    <div>{{ formatDate(cotizacion.fechaSalida) }}</div>
                    <div class="text-gray-500">{{ formatDate(cotizacion.fechaRegreso) }}</div>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-users mr-2 text-orange-500"></i>
                    Pasajeros:
                  </span>
                  <div class="text-sm text-gray-900 font-medium">
                    <span class="inline-flex items-center mr-2">
                      <i class="fas fa-user mr-1"></i>
                      {{ cotizacion.cantAdultos || 0 }}
                    </span>
                    <span *ngIf="cotizacion.cantNinos && cotizacion.cantNinos > 0" class="inline-flex items-center">
                      <i class="fas fa-child mr-1"></i>
                      {{ cotizacion.cantNinos }}
                    </span>
                  </div>
                </div>

                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600 flex items-center">
                    <i class="fas fa-dollar-sign mr-2 text-green-600"></i>
                    Moneda:
                  </span>
                  <span class="text-sm text-gray-900 font-medium">{{
                    cotizacion.moneda || 'USD'
                    }}</span>
                </div>
              </div>

              <div class="flex gap-2 pt-4 border-t border-gray-100">
                <button (click)="mostrarModalVerCotizacion(cotizacion)"
                  class="flex-1 bg-green-50 text-green-700 hover:bg-green-100 py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 hover:scale-105">
                  <i class="fas fa-eye"></i>Ver
                </button>
                <button (click)="mostrarFormularioEditar(cotizacion)"
                  class="flex-1 bg-blue-50 text-blue-700 hover:bg-blue-100 py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 hover:scale-105">
                  <i class="fas fa-edit"></i>Editar
                </button>
                <button (mousedown)="iniciarEliminacion(cotizacion)" (mouseup)="cancelarEliminacion()"
                  (mouseleave)="cancelarEliminacion()" (touchstart)="iniciarEliminacion(cotizacion)"
                  (touchend)="cancelarEliminacion()"
                  class="flex-1 bg-red-50 text-red-700 py-2 px-3 rounded-lg text-sm font-medium transition-all duration-200 flex items-center justify-center gap-2 hover:scale-105"
                  [class.bg-red-600]="
                    presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                  " [class.text-white]="
                    presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                  ">
                  <i class="fas fa-trash"></i>Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- List View -->
        <div *ngIf="currentView === 'list'" class="space-y-2">
          <div *ngFor="let cotizacion of filteredCotizaciones; trackBy: trackByCotizacion"
            class="bg-white rounded-lg border border-gray-200 hover:bg-gray-50 transition-all duration-200 p-4"
            [class.border-red-500]="isSelected(cotizacion.id)" [class.bg-red-50]="isSelected(cotizacion.id)">
            <div class="flex items-center justify-between">
              <!-- Información principal en una sola línea -->
              <div class="flex items-center gap-4 flex-1">
                <!-- Checkbox -->
                <label class="relative inline-block cursor-pointer">
                  <input type="checkbox" [checked]="isSelected(cotizacion.id)" (change)="toggleSelection(cotizacion.id)"
                    class="absolute opacity-0 w-0 h-0" />
                  <span
                    class="w-5 h-5 bg-white border-2 border-gray-300 rounded flex items-center justify-center transition-all duration-200 hover:border-red-500"
                    [class.bg-red-600]="isSelected(cotizacion.id)" [class.border-red-600]="isSelected(cotizacion.id)">
                    <i class="fas fa-check text-white text-xs" [class.hidden]="!isSelected(cotizacion.id)"></i>
                  </span>
                </label>

                <!-- Código -->
                <span class="font-semibold text-gray-900 min-w-0 flex-shrink-0">{{
                  cotizacion.codigoCotizacion
                  }}</span>

                <!-- Cliente -->
                <span class="text-gray-700 min-w-0 truncate">{{
                  getPersonaDisplayName(cotizacion.personas?.id || 0)
                  }}</span>

                <!-- Destino -->
                <span class="text-gray-600 min-w-0 flex-shrink-0">{{
                  cotizacion.origenDestino || 'Sin destino'
                  }}</span>

                <!-- Fechas -->
                <span class="text-gray-600 text-sm min-w-0 flex-shrink-0">
                  {{ formatDate(cotizacion.fechaSalida) }} -
                  {{ formatDate(cotizacion.fechaRegreso) }}
                </span>

                <!-- Pasajeros -->
                <span class="text-gray-600 text-sm min-w-0 flex-shrink-0">
                  {{ cotizacion.cantAdultos || 0 }}A
                  <span *ngIf="cotizacion.cantNinos && cotizacion.cantNinos > 0">+ {{ cotizacion.cantNinos }}N</span>
                </span>

                <!-- Estado -->
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium min-w-0 flex-shrink-0"
                  [ngClass]="getEstadoBadgeClass(cotizacion.estadoCotizacion)">
                  {{ cotizacion.estadoCotizacion?.descripcion || 'Sin estado' }}
                </span>
              </div>

              <!-- Acciones -->
              <div class="flex items-center gap-2 ml-4">
                <button (click)="mostrarModalVerCotizacion(cotizacion)"
                  class="p-2 bg-green-50 text-green-700 hover:bg-green-100 rounded transition-colors duration-200" title="Ver detalles">
                  <i class="fas fa-eye text-sm"></i>
                </button>
                <button (click)="mostrarFormularioEditar(cotizacion)"
                  class="p-2 bg-blue-50 text-blue-700 hover:bg-blue-100 rounded transition-colors duration-200" title="Editar">
                  <i class="fas fa-edit text-sm"></i>
                </button>
                <button (mousedown)="iniciarEliminacion(cotizacion)" (mouseup)="cancelarEliminacion()"
                  (mouseleave)="cancelarEliminacion()" (touchstart)="iniciarEliminacion(cotizacion)"
                  (touchend)="cancelarEliminacion()"
                  class="p-2 bg-red-50 text-red-700 hover:bg-red-100 rounded transition-colors duration-200" [class.bg-red-600]="
                    presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                  " [class.text-white]="
                    presionandoEliminar && cotizacionAEliminar?.id === cotizacion.id
                  " title="Mantener presionado para eliminar">
                  <i class="fas fa-trash text-sm"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6">
          <div class="flex flex-col lg:flex-row justify-between items-center gap-4">
            <!-- Items per page selector -->
            <div class="flex items-center gap-2 text-sm text-gray-700 font-medium">
              <span>Mostrar:</span>
              <select [(ngModel)]="itemsPerPage" (change)="onItemsPerPageChange()"
                class="border border-gray-300 rounded-lg px-3 py-2 bg-white font-medium">
                <option [value]="5">5</option>
                <option [value]="10">10</option>
                <option [value]="25">25</option>
                <option [value]="50">50</option>
              </select>
              <span>por página</span>
            </div>

            <!-- Results info -->
            <div class="text-sm font-semibold text-gray-700">
              Mostrando {{ Math.min((currentPage - 1) * itemsPerPage + 1, totalItems) }} -
              {{ Math.min(currentPage * itemsPerPage, totalItems) }} de {{ totalItems }} cotizacion{{ totalItems === 1 ?
              '' : 'es' }}
            </div>

            <!-- Navigation buttons -->
            <nav class="flex items-center gap-2" *ngIf="totalPages > 1">
              <button [disabled]="currentPage === 1" (click)="goToPage(currentPage - 1)"
                class="w-10 h-10 flex items-center justify-center rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                <i class="fas fa-chevron-left"></i>
              </button>

              <div class="flex items-center gap-1">
                <button *ngFor="let page of getVisiblePages()" (click)="goToPage(page)"
                  class="w-10 h-10 flex items-center justify-center rounded-xl text-sm font-medium transition-all duration-200"
                  [class]="page === currentPage ? 'bg-everywhere-primary text-white' : 'border border-gray-300 text-gray-700 hover:bg-gray-50'">
                  {{ page }}
                </button>
              </div>

              <button [disabled]="currentPage === totalPages" (click)="goToPage(currentPage + 1)"
                class="w-10 h-10 flex items-center justify-center rounded-xl border border-gray-300 text-gray-500 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200">
                <i class="fas fa-chevron-right"></i>
              </button>
            </nav>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Modal para Gestión de Categorías -->
<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[60] p-4"
  *ngIf="mostrarGestionGrupos" (click)="cerrarVistaGestionGrupos()">
  <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-6 py-4 rounded-t-2xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold flex items-center">
            <i class="fas fa-tags mr-2"></i>
            Gestión de Categorías
          </h2>
          <p class="text-white/90 text-sm mt-1">
            Administra las categorías disponibles para los grupos de hoteles
          </p>
        </div>
        <button (click)="cerrarVistaGestionGrupos()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors duration-200">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-4">
      <!-- Formulario para crear nueva categoría -->
      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl p-4 mb-4 border border-green-200">
        <h3 class="text-base font-semibold text-gray-900 mb-3 flex items-center">
          <i class="fas fa-plus-circle text-green-600 mr-2"></i>
          Crear Nueva Categoría
        </h3>

        <div class="space-y-3" [formGroup]="nuevaCategoriaForm">
          <div class="grid grid-cols-1 gap-4">
            <!-- Nombre de la categoría -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Nombre de la Categoría *
              </label>
              <input type="text" formControlName="nombre" placeholder="Ej: Económico, VIP, Premium..."
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500"
                [class.border-red-500]="nuevaCategoriaForm.get('nombre')?.invalid && nuevaCategoriaForm.get('nombre')?.touched" />
              <div *ngIf=" nuevaCategoriaForm.get('nombre')?.invalid && nuevaCategoriaForm.get('nombre')?.touched"
                class="text-red-500 text-sm mt-1">
                El nombre de la categoría es requerido (mínimo 3 caracteres)
              </div>
            </div>
          </div>

          <!-- Descripción opcional -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Descripción (Opcional)
            </label>
            <textarea formControlName="descripcion" placeholder="Describe esta categoría de hoteles..." rows="1"
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 resize-none">
            </textarea>
          </div>

          <!-- Botones del formulario -->
          <div class="flex gap-2">
            <button type="button" (click)="crearNuevaCategoria()"
              [disabled]="nuevaCategoriaForm.invalid || creandoCategoria"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200 flex items-center text-sm">
              <i *ngIf="!creandoCategoria" class="fas fa-plus mr-1 text-xs"></i>
              <i *ngIf="creandoCategoria" class="fas fa-spinner fa-spin mr-1 text-xs"></i>
              {{ creandoCategoria ? 'Creando...' : 'Crear Categoría' }}
            </button>
            <button type="button" (click)="limpiarFormularioNuevaCategoria()"
              class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors duration-200 flex items-center text-sm">
              <i class="fas fa-eraser mr-1 text-xs"></i>
              Limpiar
            </button>
          </div>
        </div>
      </div>

      <!-- Estado vacío -->
      <div *ngIf="categorias.length === 0" class="text-center py-8">
        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
          <i class="fas fa-tags text-blue-600 text-lg"></i>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">No hay categorías creadas</h3>
        <p class="text-gray-600 text-sm mb-4">Crea categorías para organizar los grupos de hoteles</p>
      </div>

      <!-- Tabla de categorías -->
      <div *ngIf="categorias.length > 0" class="bg-white rounded-xl border border-gray-200 overflow-hidden">
        <div class="px-4 py-3 bg-gray-50 border-b border-gray-200">
          <h3 class="text-md font-semibold text-gray-900 flex items-center">
            <i class="fas fa-list text-gray-600 mr-2"></i>
            Lista de Categorías ({{ categorias.length }})
          </h3>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-100">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  ID
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Nombre
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Creación
                </th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Última Act.
                </th>
                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <tr *ngFor="let categoria of categorias; let i = index"
                class="hover:bg-gray-50 transition-colors duration-200"
                [class.bg-yellow-50]="categoriaEditandose === i">
                <!-- ID -->
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  {{ categoria.id }}
                </td>

                <!-- Nombre (editable) -->
                <td class="px-4 py-3 whitespace-nowrap">
                  <div *ngIf="categoriaEditandose !== i">
                    <div class="text-sm font-medium text-gray-900">{{ categoria.nombre }}</div>
                  </div>
                  <div *ngIf="categoriaEditandose === i">
                    <input type="text" [(ngModel)]="categoria.nombre"
                      class="w-full px-2 py-1 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                      placeholder="Nombre de la categoría" />
                  </div>
                </td>

                <!-- Fecha de creación -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                  {{ formatearFecha(categoria.fechaCreacion) }}
                </td>

                <!-- Fecha de actualización -->
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                  {{ formatearFecha(categoria.fechaActualizacion) }}
                </td>

                <!-- Acciones -->
                <td class="px-4 py-3 whitespace-nowrap text-center">
                  <div class="flex items-center justify-center space-x-1">
                    <!-- Botones cuando NO está editando -->
                    <div *ngIf="categoriaEditandose !== i" class="flex space-x-1">
                      <button (click)="editarCategoria(i)"
                        class="p-1 text-blue-600 hover:bg-blue-50 rounded transition-colors duration-200"
                        title="Editar categoría">
                        <i class="fas fa-edit text-xs"></i>
                      </button>
                      <button (click)="confirmarEliminarCategoria(i)"
                        class="p-1 text-red-600 hover:bg-red-50 rounded transition-colors duration-200"
                        title="Eliminar categoría">
                        <i class="fas fa-trash text-xs"></i>
                      </button>
                    </div>

                    <!-- Botones cuando SÍ está editando -->
                    <div *ngIf="categoriaEditandose === i" class="flex space-x-1">
                      <button (click)="guardarEdicionCategoria(i)"
                        class="p-1 text-green-600 hover:bg-green-50 rounded transition-colors duration-200"
                        title="Guardar cambios">
                        <i class="fas fa-check text-xs"></i>
                      </button>
                      <button (click)="cancelarEdicionCategoria(i)"
                        class="p-1 text-gray-600 hover:bg-gray-50 rounded transition-colors duration-200"
                        title="Cancelar edición">
                        <i class="fas fa-times text-xs"></i>
                      </button>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar Cotización -->
<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-5"
  *ngIf="mostrarFormulario" (click)="cerrarFormulario()">
  <div class="bg-white rounded-3xl shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-y-auto"
    (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-[#D9043D] to-[#BF4968] text-white px-8 py-4 rounded-t-3xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold">
            {{ editandoCotizacion ? 'Editar Cotización' : 'Nueva Cotización' }}
          </h2>
          <p class="text-white/90 mt-1">
            {{
            editandoCotizacion
            ? 'Modifica los datos de la cotización'
            : 'Completa la información para crear la
            cotización'
            }}
          </p>
        </div>
        <button (click)="cerrarFormulario()" class="p-2 hover:bg-white/20 rounded-lg transition-colors duration-200">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Modal Body -->
    <div class="p-6">
      <form [formGroup]="cotizacionForm" (ngSubmit)="onSubmitCotizacion()">
        <!-- Información Básica -->
        <div class="mb-6">
          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <div
                class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-info-circle text-white text-sm"></i>
              </div>
              Información Básica
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <!-- Código de Cotización -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Código de Cotización
                </label>
                <input type="text" formControlName="codigoCotizacion"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-gray-50"
                  readonly />
              </div>

              <!-- Fecha de Emisión -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Fecha de Emisión
                  <span class="text-red-500">*</span>
                </label>
                <input type="datetime-local" formControlName="fechaEmision"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [class.border-red-300]="isFieldInvalid(cotizacionForm, 'fechaEmision')" />
                <div *ngIf="isFieldInvalid(cotizacionForm, 'fechaEmision')"
                  class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-sm text-red-600 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    La fecha de emisión es requerida
                  </p>
                </div>
              </div>

              <!-- Fecha de Vencimiento -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Fecha de Vencimiento
                  <span class="text-red-500">*</span>
                </label>
                <input type="datetime-local" formControlName="fechaVencimiento"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [class.border-red-300]="isFieldInvalid(cotizacionForm, 'fechaVencimiento')" />
                <div *ngIf="isFieldInvalid(cotizacionForm, 'fechaVencimiento')"
                  class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-sm text-red-600 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    La fecha de vencimiento es requerida
                  </p>
                </div>
              </div>

              <!-- Estado de Cotización -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Estado de Cotización
                </label>
                <select formControlName="estadoCotizacionId"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [class.border-red-300]="isFieldInvalid(cotizacionForm, 'estadoCotizacionId')">
                  <option value="">Seleccionar estado</option>
                  <option *ngFor="let estado of estadosCotizacion" [value]="estado.id">
                    {{ estado.descripcion }}
                  </option>
                </select>
                <div *ngIf="isFieldInvalid(cotizacionForm, 'estadoCotizacionId')"
                  class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-sm text-red-600 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    {{ getFieldError(cotizacionForm, 'estadoCotizacionId') }}
                  </p>
                </div>
              </div>

              <!-- Sucursal -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Sucursal
                </label>
                <select formControlName="sucursalId"
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  [class.border-red-300]="isFieldInvalid(cotizacionForm, 'sucursalId')">
                  <option value="">Seleccionar sucursal</option>
                  <option *ngFor="let sucursal of sucursales" [value]="sucursal.id">
                    {{ sucursal.descripcion }}
                  </option>
                </select>
                <div *ngIf="isFieldInvalid(cotizacionForm, 'sucursalId')"
                  class="mt-2 p-2 bg-red-50 border border-red-200 rounded-lg">
                  <p class="text-sm text-red-600 flex items-center">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    {{ getFieldError(cotizacionForm, 'sucursalId') }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sección Cliente e Información del Paquete en fila -->
        <div class="mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Sección Cliente -->
          <div>
            <div
              class="bg-gradient-to-r from-[#D9043D]/5 to-[#BF4968]/5 rounded-2xl p-6 border border-everywhere-primary/10 h-full flex flex-col">
              <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <div
                  class="w-8 h-8 bg-gradient-to-r from-[#D9043D] to-[#BF4968] rounded-xl flex items-center justify-center mr-3">
                  <i class="fas fa-user text-white text-sm"></i>
                </div>
                Información del Cliente
                <span class="text-red-500 ml-1">*</span>
              </h3>

              <!-- Cliente ya seleccionado -->
              <div *ngIf="clienteSeleccionado" class="bg-white border-2 border-black-200 rounded-xl p-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                      <lucide-icon name="circle-user-round" class="text-green-600 text-lg"></lucide-icon>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-900 text-base">
                        {{ getSelectedClienteName() }}
                      </p>
                      <p class="text-sm text-gray-500 flex items-center mt-1">
                        <i class="fas fa-tag mr-1"></i>
                        {{ getClienteType(clienteSeleccionado) }}
                      </p>
                    </div>
                  </div>
                  <button type="button" (click)="resetClienteSeleccionado()"
                    class="px-4 py-2 text-everywhere-primary hover:bg-everywhere-primary/10 rounded-lg transition-colors duration-200 flex items-center space-x-2">
                    <lucide-icon name="refresh-ccw" class="w-5 h-5"></lucide-icon>
                    <span class="text-sm font-medium">Cambiar</span>
                  </button>
                </div>
              </div>

              <!-- Búsqueda simple de cliente -->
              <div *ngIf="!clienteSeleccionado" class="space-y-3">
                <div class="relative">
                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                  </div>
                  <input type="text" [formControl]="clienteSearchControl"
                    placeholder="Buscar cliente por nombre, DNI, RUC..."
                    class="w-full pl-10 pr-10 py-3 border border-gray-300 rounded-lg focus:border-everywhere-primary focus:ring-2 focus:ring-everywhere-primary/20 transition-all duration-200 bg-gray-50 focus:bg-white"
                    [class.border-red-300]="isFieldInvalid(cotizacionForm, 'personaId')" autocomplete="off" />
                  <button *ngIf="clienteSearchControl.value" (click)="clearClienteSearch()" type="button"
                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                  </button>
                </div>

                <!-- Lista de clientes compacta -->
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden h-80 flex flex-col">
                  <!-- Lista deslizable de clientes - SIEMPRE VISIBLE -->
                  <div class="flex-1 overflow-y-auto">
                    <!-- Indicador de búsqueda si está activa -->
                    <div *ngIf="buscandoClientes" class="flex items-center justify-center py-2 bg-gray-50 border-b">
                      <div class="flex items-center space-x-2 text-everywhere-primary">
                        <i class="fas fa-spinner fa-spin text-xs"></i>
                        <span class="text-xs">Buscando...</span>
                      </div>
                    </div>

                    <!-- Resultados encontrados -->
                    <div *ngFor="let persona of personasEncontradas; let i = index"
                      class="border-b border-gray-100 last:border-b-0 hover:bg-everywhere-primary/5 cursor-pointer transition-colors"
                      (click)="seleccionarCliente(persona)">
                      <div class="p-3 flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                          <!-- Avatar del cliente -->
                          <div
                            class="w-8 h-8 bg-gradient-to-br from-everywhere-primary to-everywhere-secondary rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-white text-xs"></i>
                          </div>
                          <!-- Información del cliente -->
                          <div class="flex-1 min-w-0">
                            <p class="font-medium text-gray-900 truncate text-sm">
                              {{ getClienteDisplayName(persona) }}
                            </p>
                            <div class="flex items-center space-x-2 mt-0.5">
                              <span class="text-xs text-gray-500">{{
                                getClienteType(persona)
                                }}</span>
                              <span *ngIf="hasDocumento(persona)" class="text-xs text-gray-400">{{
                                getClienteDocumento(persona)
                                }}</span>
                            </div>
                          </div>
                        </div>
                        <!-- Icono de selección -->
                        <div class="text-everywhere-primary">
                          <i class="fas fa-chevron-right text-xs"></i>
                        </div>
                      </div>
                    </div>

                    <!-- Estado cuando no hay clientes -->
                    <div *ngIf="personasEncontradas.length === 0" class="text-center py-8 bg-gray-50">
                      <div class="flex flex-col items-center space-y-3">
                        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center">
                          <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <div>
                          <p class="text-gray-600 font-medium text-sm">
                            No se encontraron clientes
                          </p>
                          <p class="text-xs text-gray-500 mt-1">
                            {{
                            clienteSearchControl.value
                            ? 'Intenta con otros términos'
                            : 'No hay clientes registrados'
                            }}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div *ngIf="isFieldInvalid(cotizacionForm, 'personaId')"
              class="mt-2 p-3 bg-red-50 border border-red-200 rounded-lg">
              <p class="text-sm text-red-600 flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                {{ getFieldError(cotizacionForm, 'personaId') }}
              </p>
            </div>
          </div>

          <!-- Información del Paquete -->
          <div>
            <div
              class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200 h-full flex flex-col">
              <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
                <div
                  class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-3">
                  <i class="fas fa-map-marked-alt text-white text-sm"></i>
                </div>
                Información del Paquete
              </h3>

              <div class="space-y-4 flex-1 overflow-y-auto">
                <!-- Origen - Destino -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Origen - Destino
                  </label>
                  <div class="relative">
                    <input type="text" formControlName="origenDestino" placeholder="Ej: Lima - Cusco"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent pr-10 text-sm" />
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                      <i class="fas fa-route text-gray-400 text-xs"></i>
                    </div>
                  </div>
                </div>

                <!-- Fechas en 2 columnas -->
                <div class="grid grid-cols-2 gap-3">
                  <!-- Fecha de Salida -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Fecha de Salida
                    </label>
                    <input type="date" formControlName="fechaSalida"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Fecha de Regreso -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Fecha de Regreso
                    </label>
                    <input type="date" formControlName="fechaRegreso"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm" />
                  </div>
                </div>

                <!-- Cantidad de personas en 2 columnas -->
                <div class="grid grid-cols-2 gap-3">
                  <!-- Cantidad de Adultos -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Cantidad de Adultos
                    </label>
                    <div class="relative">
                      <input type="number" formControlName="cantAdultos" min="1" placeholder="1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent pr-8 text-sm" />
                      <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <i class="fas fa-user text-gray-400 text-xs"></i>
                      </div>
                    </div>
                  </div>

                  <!-- Cantidad de Niños -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Cantidad de Niños
                    </label>
                    <div class="relative">
                      <input type="number" formControlName="cantNinos" min="0" placeholder="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent pr-8 text-sm" />
                      <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                        <i class="fas fa-child text-gray-400 text-xs"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Forma de Pago y Moneda -->
                <div class="grid grid-cols-2 gap-3">
                  <!-- Forma de Pago -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      Forma de Pago
                    </label>
                    <select formControlName="formaPagoId"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                      <option value="">Seleccionar forma de pago</option>
                      <option *ngFor="let formaPago of formasPago" [value]="formaPago.id">
                        {{ formaPago.descripcion }}
                      </option>
                    </select>
                  </div>

                  <!-- Moneda -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"> Moneda </label>
                    <select formControlName="moneda"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm">
                      <option value="USD">Dólares (USD)</option>
                      <option value="PEN">Soles (PEN)</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Productos Fijos -->
        <div class="mb-6">
          <div class="bg-gradient-to-r from-purple-50 to-violet-50 rounded-2xl p-6 border border-purple-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <div
                class="w-8 h-8 bg-gradient-to-r from-purple-500 to-violet-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-boxes text-white text-sm"></i>
              </div>
              Productos
            </h3>

            <!-- Formulario para agregar producto -->
            <div class="bg-white rounded-xl p-6 border border-purple-100">
              <div>
                <div class="grid gap-3 items-end"
                  style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px 80px;">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Precio Unitario</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Comisión</label>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                  </div>
                  <div class="text-center">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Acciones</label>
                  </div>
                </div>
              </div>
              <div *ngFor="let detalle of detallesFijos; let i = index">
                <div class="grid gap-3 items-end"
                  style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px 80px;">
                  <!-- Proveedor -->
                  <div>
                    <select [value]="detalle.proveedor?.id || ''"
                      (change)="onProductoChange(i, 'proveedorId', $any($event.target).value)"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                      <option value="">Sin proveedor</option>
                      <option *ngFor="let proveedor of proveedores" [value]="proveedor.id"
                        [selected]="proveedor.id === detalle.proveedor?.id">
                        {{ proveedor.nombre }}
                      </option>
                    </select>
                  </div>

                  <!-- Producto -->
                  <div>
                    <select [value]="detalle.producto?.id || ''"
                      (change)="onProductoChange(i, 'productoId', $any($event.target).value)"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                      <option value="">Seleccionar</option>
                      <option *ngFor="let producto of productos" [value]="producto.id"
                        [selected]="producto.id === detalle.producto?.id">
                        {{ producto.tipo }}
                      </option>
                    </select>
                  </div>

                  <!-- Cantidad -->
                  <div>
                    <input type="number" [value]="detalle.cantidad"
                      (input)="onProductoChange(i, 'cantidad', $any($event.target).value)" min="1"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Descripción -->
                  <div>
                    <input type="text" [value]="detalle.descripcion"
                      (input)="onProductoChange(i, 'descripcion', $any($event.target).value)" placeholder="Descripción"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Precio Unitario -->
                  <div>
                    <input type="number" [value]="detalle.precioHistorico"
                      (input)="onProductoChange(i, 'precioHistorico', $any($event.target).value)" step="0.01" min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Comisión -->
                  <div>
                    <input type="number" [value]="detalle.comision"
                      (input)="onProductoChange(i, 'comision', $any($event.target).value)" step="0.01" min="0"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Total -->
                  <div>
                    <div
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm font-semibold text-purple-600 bg-purple-50 text-center">
                      ${{ detalle.total | number : '1.2-2' }}
                    </div>
                  </div>

                  <!-- Acciones -->
                  <div class="text-center">
                    <button type="button" (click)="eliminarDetalleFijo(i)"
                      class="inline-flex items-center justify-center w-8 h-8 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors duration-200">
                      <i class="fas fa-trash text-xs"></i>
                    </button>
                  </div>
                </div>
                <div class="my-2"></div>
              </div>
              <div [formGroup]="detalleForm">
                <!-- Una sola fila con todos los campos -->
                <div class="grid gap-3 items-end"
                  style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px 80px;">
                  <!-- Proveedor -->
                  <div>
                    <select formControlName="proveedorId"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                      <option value="">Opcional</option>
                      <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                        {{ proveedor.nombre }}
                      </option>
                    </select>
                  </div>

                  <!-- Producto -->
                  <div>
                    <select formControlName="productoId"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                      [class.border-red-300]="isFieldInvalid(detalleForm, 'productoId')">
                      <option value="">Seleccionar</option>
                      <option *ngFor="let producto of productos" [value]="producto.id">
                        {{ producto.tipo }}
                      </option>
                    </select>
                  </div>

                  <!-- Cantidad -->
                  <div>
                    <input type="number" formControlName="cantidad" min="1" placeholder="1"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                      [class.border-red-300]="isFieldInvalid(detalleForm, 'cantidad')" />
                  </div>

                  <!-- Descripción -->
                  <div>
                    <input type="text" formControlName="descripcion" placeholder="Descripción del producto"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                  </div>

                  <!-- Precio Unitario -->
                  <div>
                    <input type="number" formControlName="precioHistorico" step="0.01" min="0" placeholder="0.00"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                      [class.border-red-300]="isFieldInvalid(detalleForm, 'precioHistorico')" />
                  </div>

                  <!-- Comision -->
                  <div>
                    <input type="number" formControlName="comision" step="0.01" min="0" placeholder="0.00"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                      [class.border-red-300]="isFieldInvalid(detalleForm, 'comision')" />
                  </div>

                  <!-- Total -->
                  <div>
                    <input type="text" [value]="calcularTotalDetalle() | currency : 'USD' : 'symbol' : '1.2-2'"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-medium text-gray-700 text-center"
                      readonly />
                  </div>

                  <!-- Botón Agregar -->
                  <div class="text-center">
                    <button type="button" (click)="agregarDetalleFijo()"
                      class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-purple-500 to-violet-600 text-white rounded-lg hover:from-purple-600 hover:to-violet-700 transition-all duration-200 text-sm font-medium">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>


          </div>
        </div>

        <!-- Total Productos Fijos -->
        <div *ngIf="detallesFijos.length > 0" class="mt-2 mb-6 flex justify-end">
          <div class="bg-everywhere-primary/10 px-4 py-2 rounded-lg">
            <span class="text-sm font-medium text-gray-700">
              Tarifa Productos:
              <span class="font-bold text-everywhere-primary">
                ${{ calcularTotalFijos() | number : '1.2-2' }} USD
              </span>
            </span>
          </div>
        </div>

        <!-- Grupos de Hoteles -->
        <div class="mb-4">
          <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-4 border border-orange-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <div
                class="w-8 h-8 bg-gradient-to-r from-orange-500 to-amber-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-hotel text-white text-sm"></i>
              </div>
              Grupos de Hoteles
            </h3>

            <!-- Crear nuevo grupo -->
            <div class="bg-white rounded-xl p-4 mb-4 border border-orange-100">
              <div class="flex items-center justify-between mb-3">
                <h4 class="text-md font-semibold text-gray-800 flex items-center">
                  <div class="w-6 h-6 bg-orange-100 rounded-lg flex items-center justify-center mr-2">
                    <i class="fas fa-plus text-orange-600 text-xs"></i>
                  </div>
                  Crear Nuevo Grupo
                </h4>

                <!-- Botón para gestionar grupos existentes -->
                <button type="button" (click)="mostrarVistaGestionGrupos()"
                  class="px-4 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-all duration-200 text-sm font-medium flex items-center space-x-2">
                  <i class="fas fa-cogs"></i>
                  <span>Gestionar Categorías</span>
                </button>
              </div>
              <div>
                <div [formGroup]="grupoHotelForm" class="flex gap-3 items-end">
                  <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                    <select formControlName="categoria"
                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                      <option value="">Seleccionar categoría</option>
                      <option *ngFor="let categoria of getCategoriasDisponibles()" [value]="categoria.id">
                        {{ categoria.nombre }}
                      </option>
                    </select>
                  </div>
                  <div class="flex-shrink-0">
                    <button type="button" (click)="crearGrupoHotel()"
                      class="px-4 py-2 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-lg hover:from-orange-600 hover:to-amber-700 transition-all duration-200 text-sm font-medium flex items-center space-x-2">
                      <i class="fas fa-plus text-xs"></i>
                      <span>Crear Grupo</span>
                    </button>
                  </div>
                </div>
              </div>

              <div *ngFor="let grupo of gruposHoteles; let gi = index" class="mb-4 mt-4">
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                  <div class="bg-gray-50 px-3 py-2 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <!-- Botón de selección única del grupo -->
                      <div class="flex items-center">
                        <button
                          type="button"
                          (click)="seleccionarGrupoUnico(gi)"
                          class="relative w-6 h-6 rounded-full border-2 transition-all duration-200 hover:scale-110 focus:outline-none focus:ring-2 focus:ring-everywhere-primary focus:ring-offset-1"
                          [class]="isGrupoSeleccionado(gi)
                            ? 'bg-everywhere-primary border-everywhere-primary shadow-lg'
                            : 'bg-white border-gray-300 hover:border-everywhere-primary'"
                          [title]="isGrupoSeleccionado(gi) ? 'Grupo seleccionado - Click para deseleccionar' : 'Click para seleccionar este grupo'"
                          [id]="'grupo-' + gi">

                          <!-- Círculo interno cuando está seleccionado -->
                          <div
                            *ngIf="isGrupoSeleccionado(gi)"
                            class="absolute inset-1 bg-white rounded-full animate-in zoom-in duration-200">
                          </div>

                          <!-- Icono de check cuando está seleccionado -->
                          <i
                            *ngIf="isGrupoSeleccionado(gi)"
                            class="fas fa-check absolute inset-0 flex items-center justify-center text-everywhere-primary text-xs">
                          </i>
                        </button>
                        <label [for]="'grupo-' + gi" class="sr-only">Seleccionar grupo único</label>
                      </div>

                      <h4 class="font-medium text-gray-900">Grupo {{ grupo.categoria.nombre }}</h4>

                      <!-- Indicador de selección -->
                      <span
                        *ngIf="isGrupoSeleccionado(gi)"
                        class="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-medium shadow-sm animate-in slide-in-from-right duration-300">
                        <i class="fas fa-check-circle mr-1"></i>
                        Grupo Seleccionado
                      </span>
                    </div>
                    <div class="flex items-center gap-4">
                      <span class="text-sm font-medium text-everywhere-primary">
                        Total: ${{ grupo.total | number : '1.2-2' }} USD
                      </span>
                      <button type="button" (click)="eliminarGrupoHotel(gi)" class="text-red-600 hover:text-red-900">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>

                  <!-- Productos del grupo con diseño moderno -->
                  <div class="p-3 bg-white border-t border-gray-200">
                    <div class="bg-white rounded-xl border border-gray-200">
                      <!-- Header row -->
                      <div class="grid gap-3 items-end p-3 border-b border-gray-100 bg-gray-50"
                        style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px 80px;">
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Precio Unitario</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Comisión</label>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-gray-700 mb-1">Total</label>
                        </div>
                        <div class="text-center">
                          <label class="block text-sm font-medium text-gray-700 mb-1">Acciones</label>
                        </div>
                      </div>

                      <!-- Existing products as editable rows -->
                      <div *ngFor="let detalle of grupo.detalles; let di = index"
                        class="p-3 last:border-b-0">
                        <div class="grid gap-3 items-center"
                          style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px 80px;">
                          <!-- Proveedor -->
                          <div>
                            <select [value]="detalle.proveedor?.id || ''"
                              (change)="onGrupoProductoChange(gi, di, 'proveedorId', $any($event.target).value)"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                              <option value="">Sin proveedor</option>
                              <option *ngFor="let proveedor of proveedores" [value]="proveedor.id"
                                [selected]="proveedor.id === detalle.proveedor?.id">
                                {{ proveedor.nombre }}
                              </option>
                            </select>
                          </div>

                          <!-- Tipo -->
                          <div>
                            <select [value]="detalle.producto?.id || ''"
                              (change)="onGrupoProductoChange(gi, di, 'productoId', $any($event.target).value)"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                              <option value="">Seleccionar</option>
                              <option *ngFor="let producto of productos" [value]="producto.id"
                                [selected]="producto.id === detalle.producto?.id">
                                {{ producto.tipo }}
                              </option>
                            </select>
                          </div>

                          <!-- Cantidad -->
                          <div>
                            <input type="number" [value]="detalle.cantidad"
                              (input)="onGrupoProductoChange(gi, di, 'cantidad', $any($event.target).value); recalcularTotalDetalleGrupo(gi, di)" min="1"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm" />
                          </div>

                          <!-- Descripción -->
                          <div>
                            <input type="text" [value]="detalle.descripcion"
                              (input)="onGrupoProductoChange(gi, di, 'descripcion', $any($event.target).value)"
                              placeholder="Descripción"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm" />
                          </div>

                          <!-- Precio Unitario -->
                          <div>
                            <input type="number" [value]="detalle.precioHistorico"
                              (input)="onGrupoProductoChange(gi, di, 'precioHistorico', $any($event.target).value); recalcularTotalDetalleGrupo(gi, di)"
                              step="0.01" min="0"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm" />
                          </div>

                          <!-- Comisión -->
                          <div>
                            <input type="number" [value]="detalle.comision"
                              (input)="onGrupoProductoChange(gi, di, 'comision', $any($event.target).value); recalcularTotalDetalleGrupo(gi, di)"
                              step="0.01" min="0"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm" />
                          </div>

                          <!-- Total -->
                          <div>
                            <div
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-orange-600 bg-orange-50 text-center">
                              ${{ detalle.total | number : '1.2-2' }}
                            </div>
                          </div>

                          <!-- Acciones -->
                          <div class="text-center">
                            <button type="button" (click)="eliminarDetalleDeGrupo(gi, di)"
                              class="inline-flex items-center justify-center w-8 h-8 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors duration-200">
                              <i class="fas fa-trash text-xs"></i>
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- New product form row -->
                      <div class="p-3 bg-gray-50/50" [formGroup]="detalleForm">
                        <div class="grid gap-3 items-end"
                          style="grid-template-columns: 1.2fr 1fr 80px 100px 100px 80px;">
                          <!-- Proveedor -->
                          <div>
                            <select formControlName="proveedorId"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                              <option value="">Opcional</option>
                              <option *ngFor="let proveedor of proveedores" [value]="proveedor.id">
                                {{ proveedor.nombre }}
                              </option>
                            </select>
                          </div>

                          <!-- Tipo -->
                          <div>
                            <select formControlName="productoId"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                              [class.border-red-300]="isFieldInvalid(detalleForm, 'productoId')">
                              <option value="">Seleccionar</option>
                              <option *ngFor="let producto of productos" [value]="producto.id">
                                {{ producto.tipo }}
                              </option>
                            </select>
                          </div>

                          <!-- Cantidad -->
                          <div>
                            <input type="number" formControlName="cantidad" min="1" placeholder="1"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                              [class.border-red-300]="isFieldInvalid(detalleForm, 'cantidad')" />
                          </div>

                          <!-- Precio USD -->
                          <div>
                            <input type="number" formControlName="precioHistorico" step="0.01" min="0"
                              placeholder="0.00"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm"
                              [class.border-red-300]="isFieldInvalid(detalleForm, 'precioHistorico')" />
                          </div>

                          <!-- Total -->
                          <div>
                            <input type="text" [value]="calcularTotalDetalle() | currency : 'USD' : 'symbol' : '1.2-2'"
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm font-medium text-gray-700 text-center"
                              readonly />
                          </div>

                          <!-- Botón Agregar -->
                          <div class="text-center">
                            <button type="button" (click)="agregarDetalleAGrupo(gi)"
                              class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-orange-500 to-amber-600 text-white rounded-lg hover:from-orange-600 hover:to-amber-700 transition-all duration-200 text-sm font-medium">
                              <i class="fas fa-plus"></i>
                            </button>
                          </div>
                        </div>
                      </div>


                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen de Cotización -->
        <div class="mb-6">
          <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-6 border border-emerald-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <div
                class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-calculator text-white text-sm"></i>
              </div>
              Resumen de Cotización
            </h3>

            <div class="bg-white rounded-xl p-6 border border-emerald-100">
              <div class="space-y-4">
                <!-- Tarifa Productos Fijos -->
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                  <span class="text-gray-700 font-medium">Tarifa Productos:</span>
                  <span class="font-semibold text-gray-900">${{ calcularTotalFijos() | number : '1.2-2' }} USD</span>
                </div>

                <!-- Tarifas por Grupo -->
                <div *ngFor="let grupo of gruposHoteles"
                  class="flex justify-between items-center py-2 border-b border-gray-100">
                  <span class="text-gray-700 font-medium">Tarifa Grupo {{ grupo.categoria.nombre }}:</span>
                  <span class="font-semibold text-gray-900">${{ grupo.total | number : '1.2-2' }} USD</span>
                </div>

                <!-- Cotización más económica -->
                <div
                  class="flex justify-between items-center py-3 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg px-4 border border-emerald-200">
                  <span class="font-semibold text-gray-900 text-lg">Cotización más económica:</span>
                  <span class="font-bold text-emerald-600 text-2xl">
                    ${{ calcularCotizacionEconomica() | number : '1.2-2' }} USD
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Observaciones -->
        <div class="mb-6">
          <div class="bg-gradient-to-r from-slate-50 to-gray-50 rounded-2xl p-6 border border-slate-200">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <div
                class="w-8 h-8 bg-gradient-to-r from-slate-500 to-gray-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-sticky-note text-white text-sm"></i>
              </div>
              Observaciones
            </h3>
            <textarea formControlName="observacion" rows="4"
              placeholder="Observaciones adicionales sobre la cotización..."
              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent resize-none bg-white"></textarea>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
          <div class="flex flex-col sm:flex-row gap-4 justify-end">
            <button type="button" (click)="cerrarFormulario()"
              class="px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-semibold flex items-center justify-center space-x-2">
              <i class="fas fa-times"></i>
              <span>Cancelar</span>
            </button>
            <button type="submit" [disabled]="cotizacionForm.invalid || isLoading"
              class="px-8 py-3 bg-gradient-to-r from-[#D9043D] to-[#BF4968] text-white rounded-xl hover:from-[#BF4968] hover:to-[#A04057] disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-semibold shadow-lg flex items-center justify-center space-x-2">
              <span *ngIf="!isLoading" class="flex items-center space-x-2">
                <i class="fas fa-save"></i>
                <span>{{ editandoCotizacion ? 'Actualizar' : 'Crear' }} Cotización</span>
              </span>
              <span *ngIf="isLoading" class="flex items-center space-x-2">
                <i class="fas fa-spinner fa-spin"></i>
                <span>Guardando...</span>
              </span>
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Visualización de Cotización -->
<div class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-[70] p-5"
  *ngIf="mostrarModalVer" (click)="cerrarModalVer()">
  <div class="bg-white rounded-3xl shadow-2xl max-w-7xl w-full max-h-[95vh] overflow-y-auto"
    (click)="$event.stopPropagation()">

    <!-- Header del Modal -->
    <div class="bg-gradient-to-r from-green-600 to-emerald-700 text-white px-8 py-4 rounded-t-3xl">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-2xl font-bold">
            Visualizar Cotización
          </h2>
          <p class="text-white/90 mt-1" *ngIf="cotizacionCompleta">
            {{ cotizacionCompleta.codigoCotizacion }} - {{ formatDate(cotizacionCompleta.fechaEmision) }}
          </p>
        </div>
        <button (click)="cerrarModalVer()"
          class="p-2 hover:bg-white/20 rounded-lg transition-colors duration-200">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Contenido del Modal -->
    <div class="p-6" *ngIf="cotizacionCompleta">

      <!-- Información Básica -->
      <div class="mb-6">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-3">
              <i class="fas fa-info-circle text-white text-sm"></i>
            </div>
            Información Básica
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Código de Cotización -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Código de Cotización
              </label>
              <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-900 font-medium">
                {{ cotizacionCompleta.codigoCotizacion }}
              </div>
            </div>

            <!-- Fecha de Emisión -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Fecha de Emisión
              </label>
              <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-900">
                {{ formatDateTime(cotizacionCompleta.fechaEmision) }}
              </div>
            </div>

            <!-- Fecha de Vencimiento -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Fecha de Vencimiento
              </label>
              <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-900">
                {{ formatDateTime(cotizacionCompleta.fechaVencimiento) }}
              </div>
            </div>

            <!-- Estado de Cotización -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Estado de Cotización
              </label>
              <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 flex items-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="getEstadoBadgeClass(cotizacionCompleta.estadoCotizacion)">
                  {{ cotizacionCompleta.estadoCotizacion?.descripcion || 'Sin estado' }}
                </span>
              </div>
            </div>

            <!-- Sucursal -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Sucursal
              </label>
              <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-gray-50 text-gray-900">
                {{ cotizacionCompleta.sucursal?.descripcion || 'No especificada' }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sección Cliente e Información del Paquete en fila -->
      <div class="mb-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Sección Cliente -->
        <div>
          <div class="bg-gradient-to-r from-[#D9043D]/5 to-[#BF4968]/5 rounded-2xl p-6 border border-everywhere-primary/10 h-full flex flex-col">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <div class="w-8 h-8 bg-gradient-to-r from-[#D9043D] to-[#BF4968] rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-user text-white text-sm"></i>
              </div>
              Información del Cliente
            </h3>

            <!-- Cliente seleccionado (solo vista) -->
            <div class="bg-white border-2 border-gray-200 rounded-xl p-4">
              <div class="flex items-center space-x-4">
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                  <i class="fas fa-user text-green-600 text-lg"></i>
                </div>
                <div class="flex-1">
                  <p class="font-semibold text-gray-900 text-base">
                    {{ getPersonaDisplayName(cotizacionCompleta.personas?.id || 0) }}
                  </p>
                  <div class="space-y-1 mt-2">
                    <p class="text-sm text-gray-500 flex items-center">
                      <i class="fas fa-credit-card mr-2"></i>
                      Forma de Pago: {{ cotizacionCompleta.formaPago?.descripcion || 'No especificada' }}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Información del Paquete -->
        <div>
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200 h-full flex flex-col">
            <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
              <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center mr-3">
                <i class="fas fa-map-marked-alt text-white text-sm"></i>
              </div>
              Información del Paquete
            </h3>

            <div class="space-y-4 flex-1">
              <!-- Origen - Destino -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Origen - Destino
                </label>
                <div class="relative">
                  <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 pr-10 text-sm">
                    {{ cotizacionCompleta.origenDestino || 'No especificado' }}
                  </div>
                  <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                    <i class="fas fa-route text-gray-400 text-xs"></i>
                  </div>
                </div>
              </div>

              <!-- Fechas en 2 columnas -->
              <div class="grid grid-cols-2 gap-3">
                <!-- Fecha de Salida -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Fecha de Salida
                  </label>
                  <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm">
                    {{ formatDate(cotizacionCompleta.fechaSalida) }}
                  </div>
                </div>

                <!-- Fecha de Regreso -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Fecha de Regreso
                  </label>
                  <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm">
                    {{ formatDate(cotizacionCompleta.fechaRegreso) }}
                  </div>
                </div>
              </div>

              <!-- Cantidad de personas en 2 columnas -->
              <div class="grid grid-cols-2 gap-3">
                <!-- Cantidad de Adultos -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Cantidad de Adultos
                  </label>
                  <div class="relative">
                    <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 pr-8 text-sm">
                      {{ cotizacionCompleta.cantAdultos || 0 }}
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                      <i class="fas fa-user text-gray-400 text-xs"></i>
                    </div>
                  </div>
                </div>

                <!-- Cantidad de Niños -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    Cantidad de Niños
                  </label>
                  <div class="relative">
                    <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 pr-8 text-sm">
                      {{ cotizacionCompleta.cantNinos || 0 }}
                    </div>
                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                      <i class="fas fa-child text-gray-400 text-xs"></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Moneda -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Moneda
                </label>
                <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 text-sm">
                  {{ cotizacionCompleta.moneda || 'USD' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Productos Fijos -->
      <div class="mb-6" *ngIf="hasProductosFijos()">
        <div class="bg-gradient-to-r from-purple-50 to-violet-50 rounded-2xl p-6 border border-purple-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-violet-600 rounded-xl flex items-center justify-center mr-3">
              <i class="fas fa-boxes text-white text-sm"></i>
            </div>
            Productos
          </h3>

          <!-- Tabla de productos fijos -->
          <div class="bg-white rounded-xl border border-purple-100 overflow-hidden">
            <!-- Header -->
            <div class="grid gap-3 items-center p-3 border-b border-gray-100 bg-gray-50"
              style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px;">
              <div class="text-sm font-medium text-gray-700">Proveedor</div>
              <div class="text-sm font-medium text-gray-700">Producto</div>
              <div class="text-sm font-medium text-gray-700">Cantidad</div>
              <div class="text-sm font-medium text-gray-700">Descripción</div>
              <div class="text-sm font-medium text-gray-700">Precio Unit.</div>
              <div class="text-sm font-medium text-gray-700">Comisión</div>
              <div class="text-sm font-medium text-gray-700">Total</div>
            </div>

            <!-- Productos -->
            <div *ngFor="let detalle of getDetallesByCategoria(1)" class="p-3 border-b border-gray-100 last:border-b-0">
              <div class="grid gap-3 items-center"
                style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px;">
                <!-- Proveedor -->
                <div class="text-sm text-gray-900">
                  {{ detalle.proveedor?.nombre || 'Sin proveedor' }}
                </div>
                <!-- Producto -->
                <div class="text-sm text-gray-900">
                  {{ detalle.producto?.tipo || 'Sin producto' }}
                </div>
                <!-- Cantidad -->
                <div class="text-sm text-gray-900 text-center">
                  {{ detalle.cantidad || 1 }}
                </div>
                <!-- Descripción -->
                <div class="text-sm text-gray-900 truncate" [title]="detalle.descripcion">
                  {{ detalle.descripcion || 'Sin descripción' }}
                </div>
                <!-- Precio Unitario -->
                <div class="text-sm text-gray-900 text-right">
                  ${{ (detalle.precioHistorico || 0) | number:'1.2-2' }}
                </div>
                <!-- Comisión -->
                <div class="text-sm text-gray-900 text-right">
                  ${{ (detalle.comision || 0) | number:'1.2-2' }}
                </div>
                <!-- Total -->
                <div class="text-sm font-semibold text-purple-600 text-right">
                  ${{ ((detalle.precioHistorico || 0) + (detalle.comision || 0)) * (detalle.cantidad || 1) | number:'1.2-2' }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grupos de Hoteles -->
      <div class="mb-6" *ngIf="hasCategoriasNoFijas()">
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-2xl p-6 border border-orange-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-orange-500 to-amber-600 rounded-xl flex items-center justify-center mr-3">
              <i class="fas fa-hotel text-white text-sm"></i>
            </div>
            Grupos de Hoteles
          </h3>

          <!-- Cada grupo -->
          <div *ngFor="let categoria of getCategoriasNoFijas(); let gi = index" class="mb-4">
            <div class="border border-gray-200 rounded-xl overflow-hidden bg-white">
              <!-- Header del grupo -->
              <div class="bg-gray-50 px-4 py-3 flex items-center justify-between border-b border-gray-200">
                <div class="flex items-center gap-3">
                  <!-- Indicador visual de selección (solo visual, no clickeable) -->
                  <div class="flex items-center">
                    <div
                      class="relative w-6 h-6 rounded-full border-2 transition-all duration-200"
                      [class]="isGrupoSeleccionadoEnVisualizacion(gi)
                        ? 'bg-everywhere-primary border-everywhere-primary shadow-lg'
                        : 'bg-white border-gray-300'"
                      [title]="isGrupoSeleccionadoEnVisualizacion(gi) ? 'Grupo seleccionado en esta cotización' : 'Grupo no seleccionado'">

                      <!-- Círculo interno cuando está seleccionado -->
                      <div
                        *ngIf="isGrupoSeleccionadoEnVisualizacion(gi)"
                        class="absolute inset-1 bg-white rounded-full">
                      </div>

                      <!-- Icono de check cuando está seleccionado -->
                      <i
                        *ngIf="isGrupoSeleccionadoEnVisualizacion(gi)"
                        class="fas fa-check absolute inset-0 flex items-center justify-center text-everywhere-primary text-xs">
                      </i>
                    </div>
                  </div>

                  <h4 class="font-medium text-gray-900 flex items-center">
                    <i class="fas fa-tag text-orange-600 mr-2"></i>
                    Grupo {{ categoria.nombre }}
                  </h4>

                  <!-- Indicador de selección -->
                  <span
                    *ngIf="isGrupoSeleccionadoEnVisualizacion(gi)"
                    class="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-medium shadow-sm">
                    <i class="fas fa-check-circle mr-1"></i>
                    Grupo Seleccionado
                  </span>
                </div>
                <span class="text-sm font-medium text-orange-600">
                  Total: ${{ getTotalCategoria(categoria.detalles) | number:'1.2-2' }} USD
                </span>
              </div>

              <!-- Tabla de productos del grupo -->
              <div class="bg-white">
                <!-- Header de tabla -->
                <div class="grid gap-3 items-center p-3 border-b border-gray-100 bg-gray-50"
                  style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px;">
                  <div class="text-sm font-medium text-gray-700">Proveedor</div>
                  <div class="text-sm font-medium text-gray-700">Producto</div>
                  <div class="text-sm font-medium text-gray-700">Cantidad</div>
                  <div class="text-sm font-medium text-gray-700">Descripción</div>
                  <div class="text-sm font-medium text-gray-700">Precio USD</div>
                  <div class="text-sm font-medium text-gray-700">Comisión</div>
                  <div class="text-sm font-medium text-gray-700">Total USD</div>
                </div>

                <!-- Productos del grupo -->
                <div *ngFor="let detalle of categoria.detalles" class="p-3 border-b border-gray-100 last:border-b-0">
                  <div class="grid gap-3 items-center"
                    style="grid-template-columns: 1fr 1fr 80px 1.5fr 100px 100px 100px;">
                    <!-- Proveedor -->
                    <div class="text-sm text-gray-900">
                      {{ detalle.proveedor?.nombre || 'Sin proveedor' }}
                    </div>
                    <!-- Tipo -->
                    <div class="text-sm text-gray-900">
                      {{ detalle.producto?.tipo || 'Sin producto' }}
                    </div>
                    <!-- Cantidad -->
                    <div class="text-sm text-gray-900 text-center">
                      {{ detalle.cantidad || 1 }}
                    </div>
                    <!-- Descripción -->
                    <div class="text-sm text-gray-900 truncate" [title]="detalle.descripcion">
                      {{ detalle.descripcion || 'Sin descripción' }}
                    </div>
                    <!-- Precio USD -->
                    <div class="text-sm text-gray-900 text-right">
                      ${{ (detalle.precioHistorico || 0) | number:'1.2-2' }}
                    </div>
                    <!-- Comisión -->
                    <div class="text-sm text-gray-900 text-right">
                      ${{ (detalle.comision || 0) | number:'1.2-2' }}
                    </div>
                    <!-- Total -->
                    <div class="text-sm font-semibold text-orange-600 text-right">
                      ${{ ((detalle.precioHistorico || 0) + (detalle.comision || 0)) * (detalle.cantidad || 1) | number:'1.2-2' }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resumen de Cotización -->
      <div class="mb-6">
        <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-2xl p-6 border border-emerald-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-6 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-emerald-500 to-teal-600 rounded-xl flex items-center justify-center mr-3">
              <i class="fas fa-calculator text-white text-sm"></i>
            </div>
            Resumen de Cotización
          </h3>

          <div class="bg-white rounded-xl p-6 border border-emerald-100">
            <div class="space-y-4">
              <!-- Tarifa Productos Fijos -->
              <div class="flex justify-between items-center py-2 border-b border-gray-100" *ngIf="hasProductosFijos()">
                <span class="text-gray-700 font-medium">Tarifa Productos:</span>
                <span class="font-semibold text-gray-900">
                  ${{ getTotalProductosFijos() | number:'1.2-2' }} USD
                </span>
              </div>

              <!-- Tarifas por Grupo -->
              <div *ngFor="let categoria of getCategoriasNoFijas()"
                class="flex justify-between items-center py-2 border-b border-gray-100">
                <span class="text-gray-700 font-medium">Tarifa Grupo {{ categoria.nombre }}:</span>
                <span class="font-semibold text-gray-900">
                  ${{ getTotalCategoria(categoria.detalles) | number:'1.2-2' }} USD
                </span>
              </div>

              <!-- Total General -->
              <div class="flex justify-between items-center py-3 bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg px-4 border border-emerald-200">
                <span class="font-semibold text-gray-900 text-lg">Cotización más económica:</span>
                <span class="font-bold text-emerald-600 text-2xl">
                  ${{ getTotalCotizacionCompleta() | number:'1.2-2' }} {{ cotizacionCompleta.moneda || 'USD' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Observaciones -->
      <div class="mb-6" *ngIf="cotizacionCompleta.observacion">
        <div class="bg-gradient-to-r from-slate-50 to-gray-50 rounded-2xl p-6 border border-slate-200">
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
            <div class="w-8 h-8 bg-gradient-to-r from-slate-500 to-gray-600 rounded-xl flex items-center justify-center mr-3">
              <i class="fas fa-sticky-note text-white text-sm"></i>
            </div>
            Observaciones
          </h3>
          <div class="w-full px-4 py-3 border border-gray-300 rounded-xl bg-white text-gray-900 min-h-24">
            {{ cotizacionCompleta.observacion }}
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="bg-white rounded-2xl p-6 border border-gray-200 shadow-sm">
        <div class="flex flex-col sm:flex-row gap-4 justify-end">
          <button type="button" (click)="cerrarModalVer()"
            class="px-8 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-semibold flex items-center justify-center space-x-2">
            <i class="fas fa-times"></i>
            <span>Cerrar</span>
          </button>
          <button type="button" (click)="editarDesdeModa()"
            class="px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-semibold shadow-lg flex items-center justify-center space-x-2">
            <i class="fas fa-edit"></i>
            <span>Editar Cotización</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State dentro del modal -->
    <div *ngIf="!cotizacionCompleta && isLoading" class="p-12 text-center">
      <div class="inline-flex items-center gap-3">
        <i class="fas fa-spinner fa-spin text-2xl text-green-600"></i>
        <span class="text-lg font-medium text-gray-700">Cargando detalles...</span>
      </div>
    </div>
  </div>
</div>
