<div class="min-h-screen bg-gradient-to-br from-gray-50 to-slate-100">
  <!-- Sidebar Component -->
  <app-sidebar [isCollapsed]="sidebarCollapsed" [menuItems]="sidebarMenuItems" (itemClick)="onSidebarItemClick($event)"
    (toggleSidebar)="onToggleSidebar()">
  </app-sidebar>

  <!-- Main Content Area -->
  <div class="transition-all duration-300" [class.ml-72]="!sidebarCollapsed" [class.ml-20]="sidebarCollapsed">

    <!-- Loading Spinner Global -->
    <div *ngIf="isLoading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-xl p-8 flex flex-col items-center gap-4">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-everywhere-primary"></div>
        <span class="text-lg font-medium text-gray-700">Cargando documento...</span>
      </div>
    </div>

    <!-- Messages -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
      <!-- Success Message -->
      <div *ngIf="success"
        class="bg-green-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in">
        <i class="fas fa-check-circle text-xl"></i>
        <span>{{ success }}</span>
        <button (click)="hideMessages()" class="ml-4 hover:text-green-200">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Error Message -->
      <div *ngIf="error"
        class="bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in">
        <i class="fas fa-exclamation-triangle text-xl"></i>
        <span>{{ error }}</span>
        <button (click)="hideMessages()" class="ml-4 hover:text-red-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !isLoading" class="max-w-full mx-auto px-6 py-12">
      <div class="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
        <i class="fas fa-exclamation-triangle text-red-400 text-6xl mb-4"></i>
        <h2 class="text-2xl font-bold text-red-800 mb-3">Error al cargar</h2>
        <p class="text-red-600 mb-6">{{ error }}</p>
        <div class="flex gap-3 justify-center">
          <button (click)="recargarDetalles()"
            class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
            <i class="fas fa-redo mr-2"></i>
            Reintentar
          </button>
          <button (click)="volverARecibos()"
            class="px-6 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Volver a Recibos
          </button>
        </div>
      </div>
    </div>

    <!-- Content when data is loaded -->
    <div *ngIf="recibo && !isLoading" class="max-w-full mx-auto">

      <!-- Header Section -->
      <header
        class="bg-gradient-to-r from-everywhere-primary to-everywhere-secondary text-white relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-white/20 transform skew-x-12">
        </div>

        <div class="max-w-full mx-auto px-6 py-8 relative z-10">
          <!-- Mobile Menu Button -->
          <button (click)="onToggleSidebar()"
            class="lg:hidden fixed top-4 left-4 z-50 w-12 h-12 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center border border-white/30 hover:bg-white/30 transition-all">
            <i class="fas fa-bars text-xl"></i>
          </button>

          <!-- Breadcrumb -->
          <nav class="mb-6">
            <ol class="flex items-center space-x-2 text-sm">
              <li>
                <button (click)="volverARecibos()"
                  class="text-white/80 hover:text-white transition-colors flex items-center gap-1">
                  <i class="fas fa-file-contract"></i>
                  Documentos de Cobranza
                </button>
              </li>
              <li class="text-white/60">
                <i class="fas fa-chevron-right mx-2"></i>
              </li>
              <li class="text-white font-medium">
                Detalle de Recibo #{{ getNumeroRecibo(recibo) }}
              </li>
            </ol>
          </nav>

          <!-- Header Info -->
          <div class="flex flex-col lg:flex-row justify-between items-start gap-8">
            <div class="flex-1">
              <div class="flex items-center gap-4">
                <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">
                  <i class="fas fa-file-contract text-2xl"></i>
                </div>
                <div>
                  <h1 class="text-3xl font-bold">
                    Recibo #{{ getNumeroRecibo(recibo) }}
                  </h1>
                  <p class="text-white/80 text-lg">
                    {{ modoEdicion ? 'Editando detalles del recibo' : 'Gesti贸n de detalles del recibo'
                    }}
                  </p>
                  <div *ngIf="modoEdicion" class="mt-2">
                    <span
                      class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                      <i class="fas fa-edit mr-1"></i>
                      Modo Edici贸n
                    </span>
                  </div>
                </div>
              </div>

              <!-- Recibo Info Cards -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                <div class="bg-white/15 backdrop-blur-sm border border-white/20 rounded-xl p-4">
                  <div class="text-sm text-white/80">Cliente</div>
                  <div class="font-semibold text-white">{{ recibo.clienteNombre || 'Sin cliente' }}</div>
                </div>
                <div class="bg-white/15 backdrop-blur-sm border border-white/20 rounded-xl p-4">
                  <div class="text-sm text-white/80">File Venta</div>
                  <div class="font-semibold text-white">{{ recibo.fileVenta || 'Sin file' }}</div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
              <!-- PDF Actions -->
              <button (click)="verPDF()"
                class="px-6 py-3 bg-red-500/80 backdrop-blur-sm rounded-xl border border-red-400/30 hover:bg-red-500 transition-all flex items-center gap-2 text-white"
                title="Ver PDF">
                <i class="fas fa-file-pdf"></i>
                <span class="hidden sm:inline">Ver PDF</span>
              </button>

              <button (click)="descargarPDF()"
                class="px-6 py-3 bg-green-500/80 backdrop-blur-sm rounded-xl border border-green-400/30 hover:bg-green-500 transition-all flex items-center gap-2 text-white"
                title="Descargar PDF">
                <i class="fas fa-download"></i>
                <span class="hidden sm:inline">Descargar</span>
              </button>

              <button (click)="recargarDetalles()"
                class="px-6 py-3 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30 hover:bg-white/30 transition-all flex items-center gap-2">
                <i class="fas fa-sync-alt"></i>
                <span class="hidden sm:inline">Actualizar</span>
              </button>

              <div *ngIf="!modoEdicion">
                <button (click)="irAEditarRecibo()"
                  class="px-6 py-3 bg-white/20 backdrop-blur-sm rounded-xl border border-white/30 hover:bg-white/30 transition-all flex items-center gap-2">
                  <i class="fas fa-edit"></i>
                  <span class="hidden sm:inline">Editar</span>
                </button>
              </div>

              <button (click)="volverARecibos()"
                class="px-6 py-3 bg-white text-everywhere-primary rounded-xl hover:bg-gray-100 transition-colors flex items-center gap-2 font-medium">
                <i class="fas fa-arrow-left"></i>
                <span class="hidden sm:inline">Volver</span>
              </button>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <main class="px-4 py-8 max-w-full overflow-x-hidden">

        <!-- Informaci贸n del Recibo -Formulario Inline -->
        <form [formGroup]="reciboForm">
          <div
            class="bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm border border-gray-100/50 mb-6 overflow-hidden">
            <div class="p-6">
              <!-- Encabezado -->
              <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                  <div
                    class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-file-contract text-white text-sm"></i>
                  </div>
                  <div>
                    <h3 class="text-base font-semibold text-gray-900">Informaci贸n del Documento</h3>
                    <p class="text-xs text-gray-500">Datos principales del documento de cobranza</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                  <span class="text-xs text-gray-500">{{ modoEdicion ? 'Editando' : 'Vista' }}</span>
                </div>
              </div>

              <!-- Grid de Campos -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Documento/Empresa del Cliente (OBLIGATORIO) -->
                <div class="group">
                  <label class="block text-xs font-medium text-gray-600 mb-3">
                    Documento/Empresa sobre el cual se genera el documento <span class="text-red-500">*</span>
                  </label>
                  <div *ngIf="!modoEdicion"
                    class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200/50">
                    <div class="w-6 h-6 bg-blue-100 rounded-md flex items-center justify-center">
                      <i class="fas fa-id-card text-blue-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">
                      {{ recibo.personaJuridicaId ? 'RUC: ' + recibo.personaJuridicaRazonSocial + ' - ' + recibo.personaJuridicaRuc : getDetalleDocumentoDisplay() }}
                    </span>
                  </div>
                  <div *ngIf="modoEdicion" class="relative">
                    <select formControlName="detalleDocumentoId"
                      class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                      <option [value]="null" disabled>Seleccionar documento o empresa</option>
                      <!-- Documentos personales (DNI, Pasaporte, etc.) -->
                      <optgroup label=" Documentos Personales del Cliente">
                        <option *ngFor="let doc of documentosCliente" [value]="'doc_' + doc.id">
                          {{ doc.documento.tipo }}: {{ doc.numero }}
                        </option>
                      </optgroup>
                      <!-- Empresas asociadas (RUC) -->
                      <optgroup *ngIf="personasJuridicas.length > 0" label=" Empresas Asociadas al Cliente">
                        <option *ngFor="let pj of personasJuridicas" [value]="'pj_' + pj.id">
                          RUC: {{ pj.razonSocial }} - {{ pj.ruc }}
                        </option>
                      </optgroup>
                    </select>
                    <div *ngIf="reciboForm.get('detalleDocumentoId')?.invalid && reciboForm.get('detalleDocumentoId')?.touched"
                      class="mt-1 text-xs text-red-500">
                      <i class="fas fa-exclamation-circle mr-1"></i>
                      Debes seleccionar un documento o empresa
                    </div>
                  </div>
                </div>

                <!-- Sucursal (OBLIGATORIO) -->
                <div class="group">
                  <label class="block text-xs font-medium text-gray-600 mb-3">
                    Sucursal <span class="text-red-500">*</span>
                  </label>
                  <div *ngIf="!modoEdicion"
                    class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200/50">
                    <div class="w-6 h-6 bg-purple-100 rounded-md flex items-center justify-center">
                      <i class="fas fa-building text-purple-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">{{ recibo.sucursalDescripcion || 'Sin sucursal' }}</span>
                  </div>
                  <div *ngIf="modoEdicion" class="relative">
                    <select formControlName="sucursalId"
                      class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                      <option [value]="null">Seleccionar sucursal</option>
                      <option *ngFor="let sucursal of sucursales" [value]="sucursal.id">
                        {{ sucursal.descripcion }}
                      </option>
                    </select>
                    <div *ngIf="reciboForm.get('sucursalId')?.invalid && reciboForm.get('sucursalId')?.touched"
                      class="mt-1 text-xs text-red-500">
                      <i class="fas fa-exclamation-circle mr-1"></i>
                      La sucursal es obligatoria
                    </div>
                  </div>
                </div>

                <!-- Forma de Pago -->
                <div class="group">
                  <label class="block text-xs font-medium text-gray-600 mb-3">
                    Forma de Pago
                  </label>
                  <div *ngIf="!modoEdicion"
                    class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200/50">
                    <div class="w-6 h-6 bg-orange-100 rounded-md flex items-center justify-center">
                      <i class="fas fa-credit-card text-orange-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">{{ recibo.formaPagoDescripcion || 'Sin forma de pago' }}</span>
                  </div>
                  <div *ngIf="modoEdicion" class="relative">
                    <select formControlName="formaPagoId"
                      class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                      <option [value]="null">Seleccionar forma de pago</option>
                      <option *ngFor="let fp of formasPago" [value]="fp.id">
                        {{ fp.descripcion }}
                      </option>
                    </select>
                  </div>
                </div>

                <!-- Fecha de Emisi贸n -->
                <div class="group">
                  <label class="block text-xs font-medium text-gray-600 mb-3">
                    Fecha de Emisi贸n
                  </label>
                  <div *ngIf="!modoEdicion"
                    class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200/50">
                    <div class="w-6 h-6 bg-indigo-100 rounded-md flex items-center justify-center">
                      <i class="fas fa-calendar text-indigo-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">{{ (recibo.fechaEmision | date:'dd/MM/yyyy') || 'Sin fecha' }}</span>
                  </div>
                  <div *ngIf="modoEdicion" class="relative">
                    <input type="date" formControlName="fechaEmision"
                      class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                  </div>
                </div>

                <!-- File Venta -->
                <div class="group">
                  <label class="block text-xs font-medium text-gray-600 mb-3">File de Venta</label>
                  <div *ngIf="!modoEdicion"
                    class="flex items-center gap-2 p-3 bg-gray-50 rounded-lg border border-gray-200/50">
                    <div class="w-6 h-6 bg-blue-100 rounded-md flex items-center justify-center">
                      <i class="fas fa-file-alt text-blue-600 text-xs"></i>
                    </div>
                    <span class="text-sm font-medium text-gray-900">{{ recibo.fileVenta || 'Sin file' }}</span>
                  </div>
                  <div *ngIf="modoEdicion" class="relative">
                    <input type="text" formControlName="fileVenta"
                      class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm">
                  </div>
                </div>
              </div>

              <!-- Observaciones - FILA COMPLETA SEPARADA -->
              <div class="mt-4">
                <label class="block text-xs font-medium text-gray-600 mb-3">Observaciones</label>
                <div *ngIf="!modoEdicion"
                  class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200/50 overflow-hidden">
                  <div class="w-6 h-6 bg-purple-100 rounded-md flex items-center justify-center flex-shrink-0 mt-0.5">
                    <i class="fas fa-sticky-note text-purple-600 text-xs"></i>
                  </div>
                  <span class="text-sm font-medium text-gray-900 break-words whitespace-pre-wrap overflow-hidden" style="word-break: break-word; overflow-wrap: break-word;">{{ recibo.observaciones || 'Sin observaciones' }}</span>
                </div>
                <div *ngIf="modoEdicion" class="relative">
                  <textarea formControlName="observaciones" rows="3"
                    class="w-full p-3 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-sm resize-none"
                    style="word-break: break-word; overflow-wrap: break-word; white-space: pre-wrap;"></textarea>
                </div>
              </div>

            </div>
          </div>
        </form>

        <!-- Tabla de Detalles - Inline Editing -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="w-full">
            <div class="p-6">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                  <div
                    class="w-8 h-8 bg-gradient-to-r from-purple-500 to-violet-600 rounded-xl flex items-center justify-center mr-3">
                    <i class="fas fa-list-alt text-white text-sm"></i>
                  </div>
                  Detalles del Recibo
                </h3>
                <div *ngIf="modoEdicion" class="flex gap-3">
                  <button type="button" (click)="salirModoEdicion()"
                    class="px-6 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Cancelar
                  </button>
                  <button (click)="guardarCambios()" [disabled]="isLoading || !reciboForm.valid"
                    class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors disabled:opacity-50 flex items-center gap-2">
                    <i *ngIf="isLoading" class="fas fa-spinner fa-spin"></i>
                    <i *ngIf="!isLoading" class="fas fa-save"></i>
                    Guardar
                  </button>
                </div>
              </div>

              <!-- Tabla de Detalles -->
              <div class="bg-gray-50 rounded-xl p-6">
                <!-- Header Row -->
                <div class="grid gap-4 items-end mb-2"
                  [style.grid-template-columns]="modoEdicion ? 'minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px) 70px' : 'minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px)'">
                  <div><label class="block text-sm font-medium text-gray-700 mb-1">Producto</label></div>
                  <div><label class="block text-sm font-medium text-gray-700 mb-1">Descripci贸n</label></div>
                  <div><label class="block text-sm font-medium text-gray-700 mb-1">Cantidad</label></div>
                  <div><label class="block text-sm font-medium text-gray-700 mb-1">Precio Unit.</label></div>
                  <div><label class="block text-sm font-medium text-gray-700 mb-1">Total</label></div>
                  <div *ngIf="modoEdicion" class="text-center"><label
                      class="block text-sm font-medium text-gray-700 mb-1">Acciones</label></div>
                </div>

                <!-- Detalles Originales -->
                <div *ngFor="let detalle of detalles; let i = index" class="mb-3">
                  <div class="grid gap-4 items-end"
                    [style.grid-template-columns]="modoEdicion ? 'minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px) 70px' : 'minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px)'">
                    <!-- Producto -->
                    <div>
                      <select *ngIf="modoEdicion" [ngModel]="detalle.productoId"
                        (ngModelChange)="onDetalleOriginalChange(i, 'productoId', $event)"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <option value="">Seleccionar</option>
                        <option *ngFor="let producto of productos" [value]="producto.id">{{ producto.tipo }}</option>
                      </select>
                      <div *ngIf="!modoEdicion" class="px-3 py-2 bg-white rounded-lg border border-gray-200/50">
                        <span class="text-xs font-medium text-gray-900 block truncate">{{
                          getProductoNombre(detalle.productoId) }}</span>
                      </div>
                    </div>
                    <!-- Descripci贸n -->
                    <div>
                      <textarea *ngIf="modoEdicion" [value]="detalle.descripcion"
                        (input)="onDetalleOriginalChange(i, 'descripcion', $any($event.target).value)"
                        placeholder="Descripci贸n" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm resize-y min-h-[60px] max-h-[200px]"></textarea>
                      <div *ngIf="!modoEdicion" class="px-3 py-2 bg-white rounded-lg border border-gray-200/50">
                        <span class="text-xs font-medium text-gray-900 break-words">{{ detalle.descripcion || 'Sin descripci贸n' }}</span>
                      </div>
                    </div>
                    <!-- Cantidad -->
                    <div>
                      <input *ngIf="modoEdicion" type="number" [value]="detalle.cantidad"
                        (input)="onDetalleOriginalChange(i, 'cantidad', $any($event.target).value)" min="1"
                        placeholder="1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                      <div *ngIf="!modoEdicion"
                        class="px-3 py-2 bg-white rounded-lg border border-gray-200/50 text-center">
                        <span class="text-xs font-medium text-gray-900">{{ detalle.cantidad }}</span>
                      </div>
                    </div>
                    <!-- Precio -->
                    <div>
                      <input *ngIf="modoEdicion" type="number" [value]="detalle.precio"
                        (input)="onDetalleOriginalChange(i, 'precio', $any($event.target).value)" step="0.01" min="0"
                        placeholder="0.00"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                      <div *ngIf="!modoEdicion"
                        class="px-3 py-2 bg-white rounded-lg border border-gray-200/50 text-right">
                        <span class="text-xs font-medium text-gray-900">{{ recibo.moneda || 'S/' }} {{ detalle.precio | number:'1.2-2' }}</span>
                      </div>
                    </div>
                    <!-- Total -->
                    <div class="px-3 py-2 bg-blue-50 rounded-lg border border-blue-200/50 text-right">
                      <span class="text-xs font-bold text-blue-900">{{ recibo.moneda || 'S/' }} {{ ((detalle.cantidad
                        || 0) * (detalle.precio || 0)) | number:'1.2-2' }}</span>
                    </div>
                    <!-- Acciones -->
                    <div *ngIf="modoEdicion" class="text-center">
                      <button type="button" (click)="eliminarDetalleOriginal(i)"
                        class="inline-flex items-center justify-center w-8 h-8 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors duration-200">
                        <i class="fas fa-trash text-xs"></i>
                      </button>
                    </div>
                  </div>
                  <div class="my-2 border-b border-gray-300"></div>
                </div>

                <!-- Detalles Fijos (solo en modo edici贸n) -->
                <ng-container *ngIf="modoEdicion">
                  <div *ngFor="let detalle of detallesFijos; let i = index" class="mb-3">
                    <div class="grid gap-4 items-end"
                      style="grid-template-columns: minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px) 70px;">
                      <!-- Producto -->
                      <div>
                        <select [ngModel]="detalle.productoId"
                          (ngModelChange)="onDetalleFijoChange(i, 'productoId', $event)"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                          <option value="">Seleccionar</option>
                          <option *ngFor="let producto of productos" [value]="producto.id">{{ producto.tipo }}</option>
                        </select>
                      </div>
                      <!-- Descripci贸n -->
                      <div>
                        <textarea [value]="detalle.descripcion"
                          (input)="onDetalleFijoChange(i, 'descripcion', $any($event.target).value)"
                          placeholder="Descripci贸n" rows="2"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm resize-y min-h-[60px] max-h-[200px]"></textarea>
                      </div>
                      <!-- Cantidad -->
                      <div>
                        <input type="number" [value]="detalle.cantidad"
                          (input)="onDetalleFijoChange(i, 'cantidad', $any($event.target).value)" min="1"
                          placeholder="1"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                      </div>
                      <!-- Precio -->
                      <div>
                        <input type="number" [value]="detalle.precio"
                          (input)="onDetalleFijoChange(i, 'precio', $any($event.target).value)" step="0.01" min="0"
                          placeholder="0.00"
                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                      </div>
                      <!-- Total -->
                      <div class="px-3 py-2 bg-green-50 rounded-lg border border-green-200/50 text-right">
                        <span class="text-xs font-bold text-green-900">{{ recibo.moneda || 'S/' }} {{
                          ((detalle.cantidad || 0) * (detalle.precio || 0)) | number:'1.2-2' }}</span>
                      </div>
                      <!-- Acciones -->
                      <div class="text-center">
                        <button type="button" (click)="eliminarDetalleFijo(i)"
                          class="inline-flex items-center justify-center w-8 h-8 text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors duration-200">
                          <i class="fas fa-trash text-xs"></i>
                        </button>
                      </div>
                    </div>
                    <div class="my-2 border-b border-gray-300"></div>
                  </div>
                </ng-container>

                <!-- Formulario para agregar nuevo detalle (solo en modo edici贸n) -->
                <div *ngIf="modoEdicion" [formGroup]="detalleForm">
                  <div class="grid gap-4 items-end"
                    style="grid-template-columns: minmax(120px, 2fr) minmax(150px, 3fr) minmax(80px, 100px) minmax(100px, 120px) minmax(100px, 120px) 70px;">
                    <!-- Producto -->
                    <div>
                      <select formControlName="productoId"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                        <option value="">Seleccionar</option>
                        <option *ngFor="let producto of productos" [value]="producto.id">{{ producto.tipo }}</option>
                      </select>
                    </div>
                    <!-- Descripci贸n -->
                    <div>
                      <textarea formControlName="descripcion" placeholder="Descripci贸n" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm resize-y min-h-[60px] max-h-[200px]"></textarea>
                    </div>
                    <!-- Cantidad -->
                    <div>
                      <input type="number" formControlName="cantidad" min="1" placeholder="1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                    </div>
                    <!-- Precio -->
                    <div>
                      <input type="number" formControlName="precio" step="0.01" min="0" placeholder="0.00"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm" />
                    </div>
                    <!-- Total Placeholder -->
                    <div class="px-3 py-2 bg-gray-100 rounded-lg border border-gray-200/50 text-right">
                      <span class="text-xs font-medium text-gray-500">{{ recibo.moneda || 'S/' }} 0.00</span>
                    </div>
                    <!-- Bot贸n Agregar -->
                    <div class="text-center">
                      <button type="button" (click)="agregarDetalleFijo()"
                        class="inline-flex items-center justify-center w-10 h-10 bg-gradient-to-r from-purple-500 to-violet-600 text-white rounded-lg hover:from-purple-600 hover:to-violet-700 transition-all duration-200 text-sm font-medium">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Empty State -->
                <div *ngIf="detalles.length === 0 && detallesFijos.length === 0" class="text-center py-12">
                  <i class="fas fa-list text-4xl text-gray-300 mb-4"></i>
                  <h3 class="text-lg font-medium text-gray-900 mb-2">No hay detalles</h3>
                  <p class="text-gray-500">{{ modoEdicion ? 'Agregue detalles usando el formulario arriba' : 'Este recibo a煤n no tiene detalles registrados' }}</p>
                </div>
              </div>

              <!-- Totales Summary -->
              <div class="mt-6 flex justify-end">
                <div
                  class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 border border-blue-200/50 min-w-[300px]">
                  <div class="space-y-3">
                    <div class="flex justify-between items-center text-sm">
                      <span class="text-gray-600">Subtotal Detalles:</span>
                      <span class="font-medium text-gray-900">{{ recibo.moneda || 'S/' }} {{ (calcularTotal()) | number:'1.2-2' }}</span>
                    </div>
                    <div class="border-t border-blue-300 pt-3 mt-3">
                      <div class="flex justify-between items-center">
                        <span class="text-base font-semibold text-gray-900">Total:</span>
                        <span class="text-2xl font-bold text-everywhere-primary">{{ recibo.moneda || 'S/' }} {{
                          calcularTotal() | number:'1.2-2' }}</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
</div>
